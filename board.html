<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œíŒ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js" type="module"></script>
    <link rel="stylesheet" href="common.css">
    <style>
        .board-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .board-header {
            background: linear-gradient(45deg, rgba(0, 255, 136, 0.2), rgba(0, 153, 255, 0.2));
            border: 2px solid #00ff88;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .board-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
        }

        .stat-label {
            font-size: 12px;
            color: #00ccff;
            margin-top: 5px;
        }

        .post-filters {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            padding: 20px;
            border-radius: 15px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .posts-list {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 15px;
            overflow: hidden;
        }

        .post-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #333;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .post-item:hover {
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .post-item:last-child {
            border-bottom: none;
        }

        .post-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .post-status.unread {
            background: #ff0099;
            box-shadow: 0 0 10px rgba(255, 0, 153, 0.8);
            animation: pulse 2s infinite;
        }

        .post-status.read {
            background: #00ff88;
            opacity: 0.5;
        }

        .post-content {
            min-width: 0;
        }

        .post-title {
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .post-meta {
            display: flex;
            gap: 10px;
            font-size: 12px;
            color: #666;
            flex-wrap: wrap;
        }

        .post-preview {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .post-author {
            color: #00ccff;
            font-size: 13px;
            font-weight: 600;
            min-width: 80px;
        }

        .post-date {
            color: #666;
            font-size: 12px;
            min-width: 100px;
        }

        .post-comments {
            color: #ff0099;
            font-size: 12px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        .post-attachments {
            color: #ffaa00;
            font-size: 12px;
            min-width: 30px;
            text-align: center;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #333;
            background: rgba(0, 0, 0, 0.7);
            color: #00ccff;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 35px;
        }

        .page-btn:hover {
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .page-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ê¸€ ì‘ì„± ëª¨ë‹¬ */
        .post-modal .modal-content {
            max-width: 800px;
        }

        .editor-container {
            border: 2px solid #333;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            min-height: 300px;
        }

        .editor-toolbar {
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid #333;
            padding: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .editor-btn {
            padding: 5px 10px;
            border: 1px solid #333;
            background: transparent;
            color: #00ccff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .editor-btn:hover {
            border-color: #00ff88;
            color: #00ff88;
        }

        .editor-content {
            padding: 15px;
            min-height: 250px;
            outline: none;
            color: #00ff88;
            line-height: 1.6;
        }

        .file-upload-area {
            border: 2px dashed #333;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-top: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
        }

        .file-upload-area.drag-over {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .uploaded-files {
            margin-top: 15px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-preview {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            object-fit: cover;
            border: 1px solid #333;
        }

        .file-details {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            color: #00ff88;
            font-size: 12px;
            font-weight: bold;
        }

        .file-size {
            color: #666;
            font-size: 10px;
        }

        .remove-file {
            background: #ff3333;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 10px;
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00ccff);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ê¸€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ */
        .post-detail-modal .modal-content {
            max-width: 900px;
            max-height: 90vh;
        }

        .post-detail-header {
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .post-detail-title {
            font-size: 24px;
            color: #00ff88;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
        }

        .post-detail-info {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: #666;
            flex-wrap: wrap;
        }

        .post-detail-content {
            line-height: 1.8;
            color: #00ff88;
            margin-bottom: 20px;
            word-wrap: break-word;
        }

        .post-attachments-section {
            margin-bottom: 20px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .attachment-preview {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            object-fit: cover;
            border: 1px solid #333;
            cursor: pointer;
        }

        .attachment-info {
            flex: 1;
        }

        .attachment-name {
            color: #00ff88;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .attachment-size {
            color: #666;
            font-size: 11px;
        }

        .download-btn {
            padding: 5px 10px;
            background: #00ff88;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        /* ëŒ“ê¸€ ì„¹ì…˜ */
        .comments-section {
            border-top: 2px solid #333;
            padding-top: 20px;
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .comments-title {
            color: #00ff88;
            font-weight: bold;
            font-size: 16px;
        }

        .comment-form {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .comment-input {
            width: 100%;
            min-height: 80px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            color: #00ff88;
            resize: vertical;
            font-family: inherit;
        }

        .comment-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .comment-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .comment-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-author {
            color: #00ccff;
            font-weight: bold;
            font-size: 14px;
        }

        .comment-date {
            color: #666;
            font-size: 12px;
        }

        .comment-content {
            color: #00ff88;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .comment-actions-btn {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ */
        .image-preview-modal {
            background: rgba(0, 0, 0, 0.95);
        }

        .image-preview-content {
            background: transparent;
            border: none;
            box-shadow: none;
            text-align: center;
            padding: 20px;
        }

        .preview-image {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }

        .image-info {
            color: #00ff88;
            margin-top: 15px;
            font-size: 14px;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .post-item {
                grid-template-columns: auto 1fr;
                gap: 10px;
            }

            .post-author,
            .post-date,
            .post-comments,
            .post-attachments {
                display: none;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .board-stats {
                grid-template-columns: 1fr 1fr;
            }

            .post-detail-info {
                flex-direction: column;
                gap: 5px;
            }
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ê²Œì„ ì•„ì´í…œ ê´€ë¦¬</div>
            <div class="navigation">
                <a href="main.html" class="nav-link">ğŸ  ë©”ì¸ ëŒ€ì‹œë³´ë“œ</a>
                <a href="sales.html" class="nav-link">ğŸ“Š ê²Œì„ íŒë§¤ë‚´ì—­</a>
                <a href="investment.html" class="nav-link">ğŸ’° íˆ¬ìê¸ˆ ë‚´ì—­</a>
                <a href="inventory.html" class="nav-link">ğŸ“¦ í˜„ì¬ ì¬ê³ </a>
                <a href="board.html" class="nav-link active">ğŸ’¬ ì»¤ë®¤ë‹ˆí‹°</a>
            </div>
            <div class="user-info">
                <span id="userEmail"></span>
                <button id="logoutBtn" class="btn btn-secondary">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="content-section">
            <div class="section-title">
                <span>ğŸ’¬ ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œíŒ</span>
                <div class="title-buttons">
                    <button class="btn btn-primary" onclick="openPostModal()">âœï¸ ê¸€ì“°ê¸°</button>
                    <button class="btn btn-secondary" onclick="markAllAsRead()">ğŸ“– ëª¨ë‘ ì½ìŒ</button>
                </div>
            </div>

            <!-- ê²Œì‹œíŒ í—¤ë” -->
            <div class="board-header">
                <h2 style="color: #00ff88; margin-bottom: 10px;">ğŸ® ê²Œì„ ì•„ì´í…œ ì»¤ë®¤ë‹ˆí‹°</h2>
                <p style="color: #00ccff; font-size: 14px;">ì •ë³´ ê³µìœ , ì§ˆë¬¸, ììœ  í† ë¡ ì„ ìœ„í•œ ê³µê°„ì…ë‹ˆë‹¤</p>
                
                <div class="board-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalPosts">0</div>
                        <div class="stat-label">ì´ ê²Œì‹œê¸€</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalComments">0</div>
                        <div class="stat-label">ì´ ëŒ“ê¸€</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="unreadPosts">0</div>
                        <div class="stat-label">ì½ì§€ ì•Šì€ ê¸€</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayPosts">0</div>
                        <div class="stat-label">ì˜¤ëŠ˜ ì‘ì„±</div>
                    </div>
                </div>
            </div>

            <!-- í•„í„° ë° ê²€ìƒ‰ -->
            <div class="post-filters">
                <div class="filter-row">
                    <div class="form-group" style="flex: 2; margin-bottom: 0;">
                        <input type="text" id="searchInput" placeholder="ì œëª©, ë‚´ìš©, ì‘ì„±ìë¡œ ê²€ìƒ‰..." onkeyup="filterPosts()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="categoryFilter" onchange="filterPosts()">
                            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                            <option value="ì§ˆë¬¸">ì§ˆë¬¸</option>
                            <option value="ì •ë³´">ì •ë³´</option>
                            <option value="ììœ ">ììœ </option>
                            <option value="ê±°ë˜">ê±°ë˜</option>
                            <option value="ê³µì§€">ê³µì§€</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="statusFilter" onchange="filterPosts()">
                            <option value="">ì „ì²´ ìƒíƒœ</option>
                            <option value="unread">ì½ì§€ ì•ŠìŒ</option>
                            <option value="read">ì½ìŒ</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="sortFilter" onchange="filterPosts()">
                            <option value="latest">ìµœì‹ ìˆœ</option>
                            <option value="oldest">ë“±ë¡ìˆœ</option>
                            <option value="comments">ëŒ“ê¸€ìˆœ</option>
                            <option value="views">ì¡°íšŒìˆœ</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
            <div class="posts-list">
                <div id="postsContainer" class="loading">
                    <div class="loading-spinner"></div>
                    <div>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div class="pagination" id="pagination">
                <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="postModal" class="modal post-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="postModalTitle">âœï¸ ìƒˆ ê¸€ ì‘ì„±</h3>
                <span class="close" onclick="closePostModal()">&times;</span>
            </div>
            
            <form id="postForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>ì¹´í…Œê³ ë¦¬</label>
                        <select id="postCategory" required>
                            <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                            <option value="ì§ˆë¬¸">â“ ì§ˆë¬¸</option>
                            <option value="ì •ë³´">ğŸ’¡ ì •ë³´</option>
                            <option value="ììœ ">ğŸ’¬ ììœ </option>
                            <option value="ê±°ë˜">ğŸ’° ê±°ë˜</option>
                            <option value="ê³µì§€">ğŸ“¢ ê³µì§€</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>ì œëª©</label>
                        <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required maxlength="100">
                    </div>
                </div>

                <div class="form-group">
                    <label>ë‚´ìš©</label>
                    <div class="editor-container">
                        <div class="editor-toolbar">
                            <button type="button" class="editor-btn" onclick="formatText('bold')">ğŸ…± êµµê²Œ</button>
                            <button type="button" class="editor-btn" onclick="formatText('italic')">ğŸ…¸ ê¸°ìš¸ì„</button>
                            <button type="button" class="editor-btn" onclick="formatText('underline')">ğŸ…„ ë°‘ì¤„</button>
                            <button type="button" class="editor-btn" onclick="insertText('---')">â– êµ¬ë¶„ì„ </button>
                            <button type="button" class="editor-btn" onclick="insertEmoji()">ğŸ˜€ ì´ëª¨ì§€</button>
                        </div>
                        <div class="editor-content" id="postContent" contenteditable="true" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>íŒŒì¼ ì²¨ë¶€ (ì´ë¯¸ì§€, ë¬¸ì„œ)</label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <div>
                            ğŸ“ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”<br>
                            <small style="color: #666;">ìµœëŒ€ 10MB, jpg, png, gif, pdf, txt, docx ì§€ì›</small>
                        </div>
                        <input type="file" id="fileInput" multiple accept="image/*,.pdf,.txt,.docx" style="display: none;">
                    </div>
                    <div class="uploaded-files" id="uploadedFiles"></div>
                </div>

                <div style="text-align: right; margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closePostModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary" id="postSubmitBtn">ğŸ“ ì‘ì„±ì™„ë£Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ê¸€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="postDetailModal" class="modal post-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“„ ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</h3>
                <span class="close" onclick="closePostDetailModal()">&times;</span>
            </div>
            
            <div id="postDetailContent">
                <!-- ê²Œì‹œê¸€ ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
    <div id="imagePreviewModal" class="modal image-preview-modal">
        <div class="modal-content image-preview-content">
            <span class="close" onclick="closeImagePreview()" style="position: absolute; top: 20px; right: 30px; font-size: 30px; z-index: 1001;">&times;</span>
            <img id="previewImage" class="preview-image" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
            <div class="image-info" id="imageInfo"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc, query, orderBy, limit, where, onSnapshot, increment, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';

        // Firebase ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyBOikXWOMg3uj-f_kdnXh394sVDHMtboaE",
            authDomain: "game-inventory-system.firebaseapp.com",
            projectId: "game-inventory-system",
            storageBucket: "game-inventory-system.appspot.com",
            messagingSenderId: "930027493877",
            appId: "1:930027493877:web:87974d860dae032fbea8bc"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let allPosts = [];
        let filteredPosts = [];
        let currentPage = 1;
        const postsPerPage = 10;
        let uploadedFiles = [];

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function isAnonymousUser() {
            return currentUser && currentUser.isAnonymous;
        }

        function hasEditPermission() {
            return currentUser && !currentUser.isAnonymous;
        }

        function checkEditPermission(actionName = 'ì´ ê¸°ëŠ¥') {
            if (!hasEditPermission()) {
                showNotification(`${actionName}ì€ ì •ì‹ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`, 'error');
                return false;
            }
            return true;
        }

        function showNotification(message, type = 'success') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'ë‚ ì§œ ì—†ìŒ';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            if (diffHours < 1) {
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                return diffMinutes < 1 ? 'ë°©ê¸ˆ ì „' : `${diffMinutes}ë¶„ ì „`;
            } else if (diffHours < 24) {
                return `${diffHours}ì‹œê°„ ì „`;
            } else if (diffDays < 7) {
                return `${diffDays}ì¼ ì „`;
            } else {
                return date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function generateFileId() {
            return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ì¸ì¦ ìƒíƒœ í™•ì¸
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userEmailElement = document.getElementById('userEmail');
                if (userEmailElement) {
                    if (user.isAnonymous) {
                        userEmailElement.innerHTML = 'ğŸ” ê²ŒìŠ¤íŠ¸ ì‚¬ìš©ì <small style="color: #999;">(ì½ê¸° ì „ìš©)</small>';
                    } else {
                        userEmailElement.textContent = user.email;
                    }
                }
                loadPosts();
                loadBoardStats();
            } else {
                window.location.href = 'index.html';
            }
        });

        // ê²Œì‹œíŒ í†µê³„ ë¡œë“œ
        async function loadBoardStats() {
            try {
                const postsSnapshot = await getDocs(collection(db, 'posts'));
                const commentsSnapshot = await getDocs(collection(db, 'comments'));
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let totalPosts = 0;
                let totalComments = 0;
                let unreadPosts = 0;
                let todayPosts = 0;

                postsSnapshot.forEach(doc => {
                    const data = doc.data();
                    totalPosts++;
                    
                    // ì˜¤ëŠ˜ ì‘ì„±ëœ ê¸€ ê³„ì‚°
                    if (data.createdAt && data.createdAt.toDate) {
                        const postDate = data.createdAt.toDate();
                        if (postDate >= today) {
                            todayPosts++;
                        }
                    }
                    
                    // ì½ì§€ ì•Šì€ ê¸€ ê³„ì‚° (í˜„ì¬ ì‚¬ìš©ìê°€ ì½ì§€ ì•Šì€ ê¸€)
                    const readBy = data.readBy || [];
                    if (!readBy.includes(currentUser.uid)) {
                        unreadPosts++;
                    }
                });

                commentsSnapshot.forEach(doc => {
                    totalComments++;
                });

                document.getElementById('totalPosts').textContent = totalPosts.toLocaleString();
                document.getElementById('totalComments').textContent = totalComments.toLocaleString();
                document.getElementById('unreadPosts').textContent = unreadPosts.toLocaleString();
                document.getElementById('todayPosts').textContent = todayPosts.toLocaleString();

            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê²Œì‹œê¸€ ë¡œë“œ
        async function loadPosts() {
            try {
                const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                allPosts = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allPosts.push({ 
                        id: doc.id, 
                        ...data,
                        isRead: (data.readBy || []).includes(currentUser.uid)
                    });
                });
                
                filterPosts();
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('ê²Œì‹œê¸€ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                document.getElementById('postsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âš ï¸</div>
                        <div>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
            }
        }

        // ê²Œì‹œê¸€ í•„í„°ë§
        window.filterPosts = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            filteredPosts = allPosts.filter(post => {
                // ê²€ìƒ‰ì–´ í•„í„°
                const matchesSearch = !searchTerm || 
                    post.title.toLowerCase().includes(searchTerm) ||
                    post.content.toLowerCase().includes(searchTerm) ||
                    post.authorName.toLowerCase().includes(searchTerm);

                // ì¹´í…Œê³ ë¦¬ í•„í„°
                const matchesCategory = !categoryFilter || post.category === categoryFilter;

                // ì½ìŒ ìƒíƒœ í•„í„°
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'read' && post.isRead) ||
                    (statusFilter === 'unread' && !post.isRead);

                return matchesSearch && matchesCategory && matchesStatus;
            });

            // ì •ë ¬
            switch (sortFilter) {
                case 'latest':
                    filteredPosts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    break;
                case 'oldest':
                    filteredPosts.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    break;
                case 'comments':
                    filteredPosts.sort((a, b) => (b.commentsCount || 0) - (a.commentsCount || 0));
                    break;
                case 'views':
                    filteredPosts.sort((a, b) => (b.viewCount || 0) - (a.viewCount || 0));
                    break;
            }

            currentPage = 1;
            displayPosts();
        };

        // ê²Œì‹œê¸€ í‘œì‹œ
        function displayPosts() {
            const container = document.getElementById('postsContainer');
            const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
            const startIndex = (currentPage - 1) * postsPerPage;
            const endIndex = startIndex + postsPerPage;
            const currentPosts = filteredPosts.slice(startIndex, endIndex);

            if (filteredPosts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <div>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <small style="margin-top: 10px; color: #666;">ì²« ë²ˆì§¸ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</small>
                    </div>
                `;
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            container.innerHTML = currentPosts.map(post => {
                const categoryEmoji = {
                    'ì§ˆë¬¸': 'â“',
                    'ì •ë³´': 'ğŸ’¡',
                    'ììœ ': 'ğŸ’¬',
                    'ê±°ë˜': 'ğŸ’°',
                    'ê³µì§€': 'ğŸ“¢'
                };

                const hasAttachments = post.attachments && post.attachments.length > 0;
                const attachmentIcon = hasAttachments ? 'ğŸ“' : '';
                
                return `
                    <div class="post-item" onclick="openPostDetail('${post.id}')">
                        <div class="post-status ${post.isRead ? 'read' : 'unread'}"></div>
                        <div class="post-content">
                            <div class="post-title">
                                ${categoryEmoji[post.category] || 'ğŸ“„'} ${post.title}
                            </div>
                            <div class="post-meta">
                                <span>ì‘ì„±ì: ${post.authorName}</span>
                                <span>ì¡°íšŒ: ${post.viewCount || 0}</span>
                                <span>ëŒ“ê¸€: ${post.commentsCount || 0}</span>
                                ${hasAttachments ? '<span>ğŸ“ ì²¨ë¶€</span>' : ''}
                            </div>
                            <div class="post-preview">
                                ${post.content.replace(/<[^>]*>/g, '').substring(0, 100)}${post.content.length > 100 ? '...' : ''}
                            </div>
                        </div>
                        <div class="post-author">${post.authorName}</div>
                        <div class="post-date">${formatDate(post.createdAt)}</div>
                        <div class="post-comments">${post.commentsCount || 0}ê°œ</div>
                        <div class="post-attachments">${attachmentIcon}</div>
                    </div>
                `;
            }).join('');

            // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
            updatePagination(totalPages);
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // ì´ì „ í˜ì´ì§€
            if (currentPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="goToPage(${currentPage - 1})">â€¹</button>`;
            }

            // í˜ì´ì§€ ë²ˆí˜¸ë“¤
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="page-btn" style="cursor: default; border: none; background: transparent;">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="page-btn" style="cursor: default; border: none; background: transparent;">...</span>`;
                }
                paginationHTML += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            // ë‹¤ìŒ í˜ì´ì§€
            if (currentPage < totalPages) {
                paginationHTML += `<button class="page-btn" onclick="goToPage(${currentPage + 1})">â€º</button>`;
            }

            pagination.innerHTML = paginationHTML;
        }

        // í˜ì´ì§€ ì´ë™
        window.goToPage = function(page) {
            currentPage = page;
            displayPosts();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // ê¸€ì“°ê¸° ëª¨ë‹¬ ì—´ê¸°
        window.openPostModal = function() {
            if (!checkEditPermission('ê¸€ì“°ê¸°')) return;
            
            document.getElementById('postModal').style.display = 'block';
            document.getElementById('postContent').focus();
        };

        // ê¸€ì“°ê¸° ëª¨ë‹¬ ë‹«ê¸°
        window.closePostModal = function() {
            document.getElementById('postModal').style.display = 'none';
            document.getElementById('postForm').reset();
            document.getElementById('postContent').innerHTML = '';
            uploadedFiles = [];
            document.getElementById('uploadedFiles').innerHTML = '';
        };

        // íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨
        document.addEventListener('DOMContentLoaded', function() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­
            fileUploadArea.addEventListener('click', () => fileInput.click());
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('drag-over');
            });
            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('drag-over');
            });
            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        });

        function handleFiles(files) {
            for (let file of files) {
                if (file.size > 10 * 1024 * 1024) { // 10MB ì œí•œ
                    showNotification(`íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤: ${file.name} (ìµœëŒ€ 10MB)`, 'error');
                    continue;
                }

                const fileData = {
                    id: generateFileId(),
                    file: file,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: null,
                    uploaded: false
                };

                uploadedFiles.push(fileData);
                displayUploadedFile(fileData);
            }
        }

        function displayUploadedFile(fileData) {
            const container = document.getElementById('uploadedFiles');
            const fileElement = document.createElement('div');
            fileElement.className = 'uploaded-file';
            fileElement.id = `file-${fileData.id}`;

            const isImage = fileData.type.startsWith('image/');
            let previewHTML = '';

            if (isImage) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = fileElement.querySelector('.file-preview');
                    if (preview) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(fileData.file);
                previewHTML = `<img class="file-preview" style="display: none;" alt="ë¯¸ë¦¬ë³´ê¸°">`;
            } else {
                previewHTML = `<div class="file-preview" style="background: #333; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ“„</div>`;
            }

            fileElement.innerHTML = `
                <div class="file-info">
                    ${previewHTML}
                    <div class="file-details">
                        <div class="file-name">${fileData.name}</div>
                        <div class="file-size">${formatFileSize(fileData.size)}</div>
                        <div class="upload-progress" id="progress-${fileData.id}" style="display: none;">
                            <div class="upload-progress-bar" id="progress-bar-${fileData.id}"></div>
                        </div>
                        <div class="upload-status" id="status-${fileData.id}" style="font-size: 10px; color: #666;">ëŒ€ê¸° ì¤‘...</div>
                    </div>
                </div>
                <button class="remove-file" onclick="removeFile('${fileData.id}')">ì‚­ì œ</button>
            `;

            container.appendChild(fileElement);
        }

        window.removeFile = function(fileId) {
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
            const fileElement = document.getElementById(`file-${fileId}`);
            if (fileElement) {
                fileElement.remove();
            }
        };

        // ë‹¨ìˆœí•œ ì—…ë¡œë“œ í•¨ìˆ˜ (CORS ë¬¸ì œ í•´ê²°ìš©)
        async function uploadFile(fileData) {
            return new Promise((resolve, reject) => {
                console.log('íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:', fileData.name, fileData.size);
                
                try {
                    const storageRef = ref(storage, `posts/${fileData.id}_${fileData.name}`);
                    
                    // ì§„í–‰ë¥  í‘œì‹œ ìš”ì†Œ ì¤€ë¹„
                    const progressElement = document.getElementById(`progress-${fileData.id}`);
                    const progressBar = document.getElementById(`progress-bar-${fileData.id}`);
                    const statusElement = document.getElementById(`status-${fileData.id}`);
                    
                    if (progressElement && progressBar) {
                        progressElement.style.display = 'block';
                        progressBar.style.width = '0%';
                    }
                    
                    if (statusElement) {
                        statusElement.textContent = 'ì—…ë¡œë“œ ì¤‘...';
                        statusElement.style.color = '#00ccff';
                    }
                    
                    console.log('Storage ì°¸ì¡° ìƒì„± ì™„ë£Œ:', storageRef.fullPath);
                    
                    // ê°„ë‹¨í•œ uploadBytes ì‚¬ìš© (CORS ë¬¸ì œ ìµœì†Œí™”)
                    uploadBytes(storageRef, fileData.file).then(async (snapshot) => {
                        console.log('íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ:', snapshot.metadata.name);
                        
                        try {
                            const downloadURL = await getDownloadURL(snapshot.ref);
                            console.log('ë‹¤ìš´ë¡œë“œ URL íšë“:', downloadURL);
                            
                            fileData.url = downloadURL;
                            fileData.uploaded = true;
                            
                            if (progressBar) {
                                progressBar.style.width = '100%';
                            }
                            
                            if (statusElement) {
                                statusElement.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ';
                                statusElement.style.color = '#00ff88';
                            }
                            
                            setTimeout(() => {
                                if (progressElement) {
                                    progressElement.style.display = 'none';
                                }
                            }, 1000);
                            
                            resolve(fileData);
                        } catch (urlError) {
                            console.error('ë‹¤ìš´ë¡œë“œ URL íšë“ ì‹¤íŒ¨:', urlError);
                            if (statusElement) {
                                statusElement.textContent = 'URL íšë“ ì‹¤íŒ¨';
                                statusElement.style.color = '#ff3333';
                            }
                            reject(urlError);
                        }
                    }).catch((uploadError) => {
                        console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', uploadError);
                        console.error('ì—ëŸ¬ ì½”ë“œ:', uploadError.code);
                        console.error('ì—ëŸ¬ ë©”ì‹œì§€:', uploadError.message);
                        
                        if (statusElement) {
                            statusElement.textContent = 'ì—…ë¡œë“œ ì‹¤íŒ¨';
                            statusElement.style.color = '#ff3333';
                        }
                        
                        // êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€
                        let errorMessage = '';
                        switch (uploadError.code) {
                            case 'storage/unauthorized':
                                errorMessage = 'íŒŒì¼ ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                                break;
                            case 'storage/canceled':
                                errorMessage = 'íŒŒì¼ ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                                break;
                            case 'storage/unknown':
                                errorMessage = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. CORS ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                                break;
                            case 'storage/invalid-format':
                                errorMessage = 'ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
                                break;
                            case 'storage/object-not-found':
                                errorMessage = 'íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                                break;
                            default:
                                errorMessage = uploadError.message;
                        }
                        
                        showNotification(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${errorMessage}`, 'error');
                        reject(uploadError);
                    });
                    
                } catch (error) {
                    console.error('ì—…ë¡œë“œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    if (statusElement) {
                        statusElement.textContent = 'ì´ˆê¸°í™” ì‹¤íŒ¨';
                        statusElement.style.color = '#ff3333';
                    }
                    reject(error);
                }
            });
        }

        // í…ìŠ¤íŠ¸ ì„œì‹ ê¸°ëŠ¥
        window.formatText = function(command) {
            document.execCommand(command, false, null);
        };

        window.insertText = function(text) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(text));
            }
        };

        window.insertEmoji = function() {
            const emojis = ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ¤”', 'ğŸ‘', 'ğŸ‘', 'â¤ï¸', 'ğŸ‰', 'ğŸ’¯', 'ğŸ”¥', 'â­'];
            const emoji = emojis[Math.floor(Math.random() * emojis.length)];
            insertText(emoji);
        };

        // ê²Œì‹œê¸€ ì‘ì„± í¼ ì²˜ë¦¬
        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!checkEditPermission('ê¸€ ì‘ì„±')) return;

            const submitBtn = document.getElementById('postSubmitBtn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'ğŸ“¤ ì—…ë¡œë“œ ì¤‘...';

            try {
                console.log('ì—…ë¡œë“œí•  íŒŒì¼ ìˆ˜:', uploadedFiles.length);
                
                let successfulUploads = 0;
                let failedUploads = 0;
                
                if (uploadedFiles.length > 0) {
                    console.log('íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘...');
                    
                    // ê° íŒŒì¼ì„ ìˆœì°¨ì ìœ¼ë¡œ ì—…ë¡œë“œ
                    for (let i = 0; i < uploadedFiles.length; i++) {
                        const fileData = uploadedFiles[i];
                        console.log(`íŒŒì¼ ${i + 1}/${uploadedFiles.length} ì—…ë¡œë“œ ì¤‘:`, fileData.name);
                        
                        try {
                            await uploadFile(fileData);
                            successfulUploads++;
                            console.log(`íŒŒì¼ ${i + 1} ì—…ë¡œë“œ ì™„ë£Œ`);
                        } catch (fileError) {
                            console.error(`íŒŒì¼ ${i + 1} ì—…ë¡œë“œ ì‹¤íŒ¨:`, fileError);
                            failedUploads++;
                            
                            // ì—…ë¡œë“œ ì‹¤íŒ¨í•œ íŒŒì¼ì€ ë°°ì—´ì—ì„œ ì œê±°í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ë‹¤ì‹œ ì‹œë„í•  ìˆ˜ ìˆë„ë¡)
                            fileData.uploaded = false;
                            fileData.url = null;
                        }
                    }
                    
                    console.log(`ì—…ë¡œë“œ ê²°ê³¼: ì„±ê³µ ${successfulUploads}ê°œ, ì‹¤íŒ¨ ${failedUploads}ê°œ`);
                    
                    if (failedUploads > 0) {
                        showNotification(`${failedUploads}ê°œ íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¸€ì€ ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.`, 'warning');
                    }
                }

                // ê²Œì‹œê¸€ ë°ì´í„° ì¤€ë¹„ (ì—…ë¡œë“œ ì„±ê³µí•œ íŒŒì¼ë§Œ í¬í•¨)
                const postData = {
                    title: document.getElementById('postTitle').value.trim(),
                    content: document.getElementById('postContent').innerHTML,
                    category: document.getElementById('postCategory').value,
                    authorId: currentUser.uid,
                    authorName: currentUser.isAnonymous ? 'ìµëª…' : currentUser.email.split('@')[0],
                    attachments: uploadedFiles.filter(f => f.uploaded && f.url).map(f => ({
                        id: f.id,
                        name: f.name,
                        size: f.size,
                        type: f.type,
                        url: f.url
                    })),
                    viewCount: 0,
                    commentsCount: 0,
                    readBy: [currentUser.uid],
                    createdAt: serverTimestamp()
                };

                console.log('ê²Œì‹œê¸€ ë°ì´í„°:', postData);

                // Firestoreì— ì €ì¥
                const docRef = await addDoc(collection(db, 'posts'), postData);
                console.log('ê²Œì‹œê¸€ ì €ì¥ ì™„ë£Œ, ID:', docRef.id);
                
                if (successfulUploads === uploadedFiles.length) {
                    showNotification('ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } else if (uploadedFiles.length === 0) {
                    showNotification('ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } else {
                    showNotification(`ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (ì²¨ë¶€íŒŒì¼ ${successfulUploads}/${uploadedFiles.length}ê°œ ì—…ë¡œë“œë¨)`, 'success');
                }
                
                closePostModal();
                loadPosts();
                loadBoardStats();

            } catch (error) {
                console.error('ê²Œì‹œê¸€ ì‘ì„± ì‹¤íŒ¨:', error);
                showNotification('ê²Œì‹œê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });

        // ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°
        window.openPostDetail = async function(postId) {
            try {
                const postDoc = await getDoc(doc(db, 'posts', postId));
                
                if (!postDoc.exists()) {
                    showNotification('ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const postData = postDoc.data();
                
                // ì¡°íšŒìˆ˜ ì¦ê°€ ë° ì½ìŒ ì²˜ë¦¬
                const readBy = postData.readBy || [];
                if (!readBy.includes(currentUser.uid)) {
                    await updateDoc(doc(db, 'posts', postId), {
                        viewCount: increment(1),
                        readBy: [...readBy, currentUser.uid]
                    });
                } else {
                    await updateDoc(doc(db, 'posts', postId), {
                        viewCount: increment(1)
                    });
                }

                // ëŒ“ê¸€ ë¡œë“œ
                const commentsQuery = query(
                    collection(db, 'comments'),
                    where('postId', '==', postId),
                    orderBy('createdAt', 'asc')
                );
                const commentsSnapshot = await getDocs(commentsQuery);
                const comments = [];
                commentsSnapshot.forEach(doc => {
                    comments.push({ id: doc.id, ...doc.data() });
                });

                // ëª¨ë‹¬ ë‚´ìš© ìƒì„±
                const categoryEmoji = {
                    'ì§ˆë¬¸': 'â“',
                    'ì •ë³´': 'ğŸ’¡',
                    'ììœ ': 'ğŸ’¬',
                    'ê±°ë˜': 'ğŸ’°',
                    'ê³µì§€': 'ğŸ“¢'
                };

                const attachmentsHTML = postData.attachments && postData.attachments.length > 0 ? `
                    <div class="post-attachments-section">
                        <h4 style="color: #00ff88; margin-bottom: 10px;">ğŸ“ ì²¨ë¶€íŒŒì¼</h4>
                        ${postData.attachments.map(attachment => {
                            const isImage = attachment.type.startsWith('image/');
                            return `
                                <div class="attachment-item">
                                    ${isImage ? 
                                        `<img class="attachment-preview" src="${attachment.url}" alt="${attachment.name}" onclick="previewImage('${attachment.url}', '${attachment.name}')">` :
                                        `<div class="attachment-preview" style="background: #333; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ“„</div>`
                                    }
                                    <div class="attachment-info">
                                        <div class="attachment-name">${attachment.name}</div>
                                        <div class="attachment-size">${formatFileSize(attachment.size)}</div>
                                    </div>
                                    <button class="download-btn" onclick="downloadFile('${attachment.url}', '${attachment.name}')">ë‹¤ìš´ë¡œë“œ</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : '';

                const commentsHTML = `
                    <div class="comments-section">
                        <div class="comments-header">
                            <h4 class="comments-title">ğŸ’¬ ëŒ“ê¸€ (${comments.length})</h4>
                        </div>
                        
                        ${hasEditPermission() ? `
                            <div class="comment-form">
                                <textarea class="comment-input" id="newCommentContent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
                                <div class="comment-actions">
                                    <small style="color: #666;">Ctrl + Enterë¡œ ë¹ ë¥¸ ë“±ë¡</small>
                                    <button class="btn btn-primary" onclick="addComment('${postId}')">ğŸ’¬ ëŒ“ê¸€ ë“±ë¡</button>
                                </div>
                            </div>
                        ` : '<div style="text-align: center; color: #666; padding: 20px;">ëŒ“ê¸€ ì‘ì„±ì€ ì •ì‹ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>'}
                        
                        <div class="comments-list">
                            ${comments.length > 0 ? comments.map(comment => `
                                <div class="comment-item">
                                    <div class="comment-header">
                                        <span class="comment-author">${comment.authorName}</span>
                                        <span class="comment-date">${formatDate(comment.createdAt)}</span>
                                    </div>
                                    <div class="comment-content">${comment.content}</div>
                                    ${comment.authorId === currentUser.uid && hasEditPermission() ? `
                                        <div class="comment-actions-btn">
                                            <button class="btn btn-danger btn-small" onclick="deleteComment('${comment.id}', '${postId}')">ì‚­ì œ</button>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('') : '<div style="text-align: center; color: #666; padding: 20px;">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</div>'}
                        </div>
                    </div>
                `;

                document.getElementById('postDetailContent').innerHTML = `
                    <div class="post-detail-header">
                        <div class="post-detail-title">
                            ${categoryEmoji[postData.category] || 'ğŸ“„'} ${postData.title}
                        </div>
                        <div class="post-detail-info">
                            <span>ì‘ì„±ì: ${postData.authorName}</span>
                            <span>ì‘ì„±ì¼: ${formatDate(postData.createdAt)}</span>
                            <span>ì¡°íšŒ: ${(postData.viewCount || 0) + 1}</span>
                            <span>ëŒ“ê¸€: ${comments.length}</span>
                        </div>
                    </div>
                    
                    <div class="post-detail-content">
                        ${postData.content}
                    </div>
                    
                    ${attachmentsHTML}
                    ${commentsHTML}
                `;

                document.getElementById('postDetailModal').style.display = 'block';
                
                // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                loadPosts();
                loadBoardStats();

            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        };

        // ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
        window.closePostDetailModal = function() {
            document.getElementById('postDetailModal').style.display = 'none';
        };

        // ëŒ“ê¸€ ì¶”ê°€
        window.addComment = async function(postId) {
            if (!checkEditPermission('ëŒ“ê¸€ ì‘ì„±')) return;

            const content = document.getElementById('newCommentContent').value.trim();
            if (!content) {
                showNotification('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                // ëŒ“ê¸€ ì¶”ê°€
                await addDoc(collection(db, 'comments'), {
                    postId: postId,
                    content: content,
                    authorId: currentUser.uid,
                    authorName: currentUser.isAnonymous ? 'ìµëª…' : currentUser.email.split('@')[0],
                    createdAt: serverTimestamp()
                });

                // ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ ìˆ˜ ì¦ê°€
                await updateDoc(doc(db, 'posts', postId), {
                    commentsCount: increment(1)
                });

                showNotification('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
                // ëŒ“ê¸€ ë‚´ìš© ì´ˆê¸°í™”
                document.getElementById('newCommentContent').value = '';
                
                // ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° ìƒˆë¡œê³ ì¹¨
                openPostDetail(postId);

            } catch (error) {
                console.error('ëŒ“ê¸€ ì¶”ê°€ ì‹¤íŒ¨:', error);
                showNotification('ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        };

        // ëŒ“ê¸€ ì‚­ì œ
        window.deleteComment = async function(commentId, postId) {
            if (!checkEditPermission('ëŒ“ê¸€ ì‚­ì œ')) return;

            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await deleteDoc(doc(db, 'comments', commentId));
                await updateDoc(doc(db, 'posts', postId), {
                    commentsCount: increment(-1)
                });

                showNotification('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                openPostDetail(postId);

            } catch (error) {
                console.error('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:', error);
                showNotification('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        };

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        window.previewImage = function(url, name) {
            document.getElementById('previewImage').src = url;
            document.getElementById('imageInfo').textContent = name;
            document.getElementById('imagePreviewModal').style.display = 'block';
        };

        window.closeImagePreview = function() {
            document.getElementById('imagePreviewModal').style.display = 'none';
        };

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        window.downloadFile = function(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // ëª¨ë“  ê¸€ ì½ìŒ ì²˜ë¦¬
        window.markAllAsRead = async function() {
            if (!hasEditPermission()) {
                showNotification('ì½ìŒ ì²˜ë¦¬ëŠ” ì •ì‹ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (!confirm('ëª¨ë“  ê²Œì‹œê¸€ì„ ì½ìŒìœ¼ë¡œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const batch = [];
                const unreadPosts = allPosts.filter(post => !post.isRead);
                
                for (const post of unreadPosts) {
                    const readBy = post.readBy || [];
                    if (!readBy.includes(currentUser.uid)) {
                        batch.push(updateDoc(doc(db, 'posts', post.id), {
                            readBy: [...readBy, currentUser.uid]
                        }));
                    }
                }

                await Promise.all(batch);
                showNotification(`${unreadPosts.length}ê°œ ê²Œì‹œê¸€ì„ ì½ìŒìœ¼ë¡œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.`, 'success');
                
                loadPosts();
                loadBoardStats();

            } catch (error) {
                console.error('ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                showNotification('ì½ìŒ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        };

        // ëŒ“ê¸€ ì…ë ¥ë€ì—ì„œ Ctrl+Enterë¡œ ë¹ ë¥¸ ë“±ë¡
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.id === 'newCommentContent') {
                        const postId = document.querySelector('.post-detail-content') ? 
                            document.querySelector('.comments-section button[onclick*="addComment"]')?.getAttribute('onclick')?.match(/addComment\('([^']+)'\)/)?.[1] : 
                            null;
                        if (postId) {
                            addComment(postId);
                        }
                    }
                }
            });
        });

        // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    const message = isAnonymousUser() ? 
                        'ê²ŒìŠ¤íŠ¸ ì„¸ì…˜ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 
                        'ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                        
                    if (confirm(message)) {
                        import('./common.js').then(({ auth }) => {
                            import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js').then(({ signOut }) => {
                                signOut(auth).then(() => {
                                    window.location.href = 'index.html';
                                });
                            });
                        });
                    }
                });
            }
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>