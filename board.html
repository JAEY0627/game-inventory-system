<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커뮤니티 게시판</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js" type="module"></script>
    <link rel="stylesheet" href="common.css">
    <style>
        .board-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .board-header {
            background: linear-gradient(45deg, rgba(0, 255, 136, 0.2), rgba(0, 153, 255, 0.2));
            border: 2px solid #00ff88;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .board-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
        }

        .stat-label {
            font-size: 12px;
            color: #00ccff;
            margin-top: 5px;
        }

        .post-filters {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            padding: 20px;
            border-radius: 15px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .posts-list {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 15px;
            overflow: hidden;
        }

        .post-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #333;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .post-item:hover {
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .post-item:last-child {
            border-bottom: none;
        }

        .post-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .post-status.unread {
            background: #ff0099;
            box-shadow: 0 0 10px rgba(255, 0, 153, 0.8);
            animation: pulse 2s infinite;
        }

        .post-status.read {
            background: #00ff88;
            opacity: 0.5;
        }

        .post-content {
            min-width: 0;
        }

        .post-title {
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .post-meta {
            display: flex;
            gap: 10px;
            font-size: 12px;
            color: #666;
            flex-wrap: wrap;
        }

        .post-preview {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .post-author {
            color: #00ccff;
            font-size: 13px;
            font-weight: 600;
            min-width: 80px;
        }

        .post-date {
            color: #666;
            font-size: 12px;
            min-width: 100px;
        }

        .post-comments {
            color: #ff0099;
            font-size: 12px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        .post-attachments {
            color: #ffaa00;
            font-size: 12px;
            min-width: 30px;
            text-align: center;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #333;
            background: rgba(0, 0, 0, 0.7);
            color: #00ccff;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 35px;
        }

        .page-btn:hover {
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .page-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 글 작성 모달 */
        .post-modal .modal-content {
            max-width: 800px;
        }

        .editor-container {
            border: 2px solid #333;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            min-height: 300px;
        }

        .editor-toolbar {
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid #333;
            padding: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .editor-btn {
            padding: 5px 10px;
            border: 1px solid #333;
            background: transparent;
            color: #00ccff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .editor-btn:hover {
            border-color: #00ff88;
            color: #00ff88;
        }

        .editor-content {
            padding: 15px;
            min-height: 250px;
            outline: none;
            color: #00ff88;
            line-height: 1.6;
        }

        .file-upload-area {
            border: 2px dashed #333;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-top: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
        }

        .file-upload-area.drag-over {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .uploaded-files {
            margin-top: 15px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-preview {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            object-fit: cover;
            border: 1px solid #333;
        }

        .file-details {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            color: #00ff88;
            font-size: 12px;
            font-weight: bold;
        }

        .file-size {
            color: #666;
            font-size: 10px;
        }

        .remove-file {
            background: #ff3333;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 10px;
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00ccff);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* 글 상세보기 모달 */
        .post-detail-modal .modal-content {
            max-width: 900px;
            max-height: 90vh;
        }

        .post-detail-header {
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .post-detail-title {
            font-size: 24px;
            color: #00ff88;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
        }

        .post-detail-info {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: #666;
            flex-wrap: wrap;
        }

        .post-detail-content {
            line-height: 1.8;
            color: #00ff88;
            margin-bottom: 20px;
            word-wrap: break-word;
        }

        .post-attachments-section {
            margin-bottom: 20px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .attachment-preview {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            object-fit: cover;
            border: 1px solid #333;
            cursor: pointer;
        }

        .attachment-info {
            flex: 1;
        }

        .attachment-name {
            color: #00ff88;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .attachment-size {
            color: #666;
            font-size: 11px;
        }

        .download-btn {
            padding: 5px 10px;
            background: #00ff88;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        /* 댓글 섹션 */
        .comments-section {
            border-top: 2px solid #333;
            padding-top: 20px;
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .comments-title {
            color: #00ff88;
            font-weight: bold;
            font-size: 16px;
        }

        .comment-form {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .comment-input {
            width: 100%;
            min-height: 80px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            color: #00ff88;
            resize: vertical;
            font-family: inherit;
        }

        .comment-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .comment-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .comment-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-author {
            color: #00ccff;
            font-weight: bold;
            font-size: 14px;
        }

        .comment-date {
            color: #666;
            font-size: 12px;
        }

        .comment-content {
            color: #00ff88;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .comment-actions-btn {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* 이미지 미리보기 모달 */
        .image-preview-modal {
            background: rgba(0, 0, 0, 0.95);
        }

        .image-preview-content {
            background: transparent;
            border: none;
            box-shadow: none;
            text-align: center;
            padding: 20px;
        }

        .preview-image {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }

        .image-info {
            color: #00ff88;
            margin-top: 15px;
            font-size: 14px;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .post-item {
                grid-template-columns: auto 1fr;
                gap: 10px;
            }

            .post-author,
            .post-date,
            .post-comments,
            .post-attachments {
                display: none;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .board-stats {
                grid-template-columns: 1fr 1fr;
            }

            .post-detail-info {
                flex-direction: column;
                gap: 5px;
            }
        }

        /* 로딩 상태 */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        /* 빈 상태 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">게임 아이템 관리</div>
            <div class="navigation">
                <a href="main.html" class="nav-link">🏠 메인 대시보드</a>
                <a href="sales.html" class="nav-link">📊 게임 판매내역</a>
                <a href="investment.html" class="nav-link">💰 투자금 내역</a>
                <a href="inventory.html" class="nav-link">📦 현재 재고</a>
                <a href="board.html" class="nav-link active">💬 커뮤니티</a>
            </div>
            <div class="user-info">
                <span id="userEmail"></span>
                <button id="logoutBtn" class="btn btn-secondary">로그아웃</button>
            </div>
        </div>

        <div class="content-section">
            <div class="section-title">
                <span>💬 커뮤니티 게시판</span>
                <div class="title-buttons">
                    <button class="btn btn-primary" onclick="openPostModal()">✏️ 글쓰기</button>
                    <button class="btn btn-secondary" onclick="markAllAsRead()">📖 모두 읽음</button>
                </div>
            </div>

            <!-- 게시판 헤더 -->
            <div class="board-header">
                <h2 style="color: #00ff88; margin-bottom: 10px;">🎮 게임 아이템 커뮤니티</h2>
                <p style="color: #00ccff; font-size: 14px;">정보 공유, 질문, 자유 토론을 위한 공간입니다</p>
                
                <div class="board-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalPosts">0</div>
                        <div class="stat-label">총 게시글</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalComments">0</div>
                        <div class="stat-label">총 댓글</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="unreadPosts">0</div>
                        <div class="stat-label">읽지 않은 글</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayPosts">0</div>
                        <div class="stat-label">오늘 작성</div>
                    </div>
                </div>
            </div>

            <!-- 필터 및 검색 -->
            <div class="post-filters">
                <div class="filter-row">
                    <div class="form-group" style="flex: 2; margin-bottom: 0;">
                        <input type="text" id="searchInput" placeholder="제목, 내용, 작성자로 검색..." onkeyup="filterPosts()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="categoryFilter" onchange="filterPosts()">
                            <option value="">전체 카테고리</option>
                            <option value="질문">질문</option>
                            <option value="정보">정보</option>
                            <option value="자유">자유</option>
                            <option value="거래">거래</option>
                            <option value="공지">공지</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="statusFilter" onchange="filterPosts()">
                            <option value="">전체 상태</option>
                            <option value="unread">읽지 않음</option>
                            <option value="read">읽음</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="sortFilter" onchange="filterPosts()">
                            <option value="latest">최신순</option>
                            <option value="oldest">등록순</option>
                            <option value="comments">댓글순</option>
                            <option value="views">조회순</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 게시글 목록 -->
            <div class="posts-list">
                <div id="postsContainer" class="loading">
                    <div class="loading-spinner"></div>
                    <div>게시글을 불러오는 중...</div>
                </div>
            </div>

            <!-- 페이지네이션 -->
            <div class="pagination" id="pagination">
                <!-- 페이지네이션 버튼들이 여기에 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>

    <!-- 글쓰기 모달 -->
    <div id="postModal" class="modal post-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="postModalTitle">✏️ 새 글 작성</h3>
                <span class="close" onclick="closePostModal()">&times;</span>
            </div>
            
            <form id="postForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>카테고리</label>
                        <select id="postCategory" required>
                            <option value="">카테고리 선택</option>
                            <option value="질문">❓ 질문</option>
                            <option value="정보">💡 정보</option>
                            <option value="자유">💬 자유</option>
                            <option value="거래">💰 거래</option>
                            <option value="공지">📢 공지</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>제목</label>
                        <input type="text" id="postTitle" placeholder="제목을 입력하세요" required maxlength="100">
                    </div>
                </div>

                <div class="form-group">
                    <label>내용</label>
                    <div class="editor-container">
                        <div class="editor-toolbar">
                            <button type="button" class="editor-btn" onclick="formatText('bold')">🅱 굵게</button>
                            <button type="button" class="editor-btn" onclick="formatText('italic')">🅸 기울임</button>
                            <button type="button" class="editor-btn" onclick="formatText('underline')">🅄 밑줄</button>
                            <button type="button" class="editor-btn" onclick="insertText('---')">➖ 구분선</button>
                            <button type="button" class="editor-btn" onclick="insertEmoji()">😀 이모지</button>
                        </div>
                        <div class="editor-content" id="postContent" contenteditable="true" placeholder="내용을 입력하세요..."></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>파일 첨부 (이미지, 문서)</label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <div>
                            📎 파일을 드래그하거나 클릭하여 업로드하세요<br>
                            <small style="color: #666;">최대 10MB, jpg, png, gif, pdf, txt, docx 지원</small>
                        </div>
                        <input type="file" id="fileInput" multiple accept="image/*,.pdf,.txt,.docx" style="display: none;">
                    </div>
                    <div class="uploaded-files" id="uploadedFiles"></div>
                </div>

                <div style="text-align: right; margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closePostModal()">취소</button>
                    <button type="submit" class="btn btn-primary" id="postSubmitBtn">📝 작성완료</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 글 상세보기 모달 -->
    <div id="postDetailModal" class="modal post-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">📄 게시글 상세보기</h3>
                <span class="close" onclick="closePostDetailModal()">&times;</span>
            </div>
            
            <div id="postDetailContent">
                <!-- 게시글 상세 내용이 여기에 동적으로 로드됩니다 -->
            </div>
        </div>
    </div>

    <!-- 이미지 미리보기 모달 -->
    <div id="imagePreviewModal" class="modal image-preview-modal">
        <div class="modal-content image-preview-content">
            <span class="close" onclick="closeImagePreview()" style="position: absolute; top: 20px; right: 30px; font-size: 30px; z-index: 1001;">&times;</span>
            <img id="previewImage" class="preview-image" src="" alt="미리보기">
            <div class="image-info" id="imageInfo"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc, query, orderBy, limit, where, onSnapshot, increment, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';

        // Firebase 초기화
        const firebaseConfig = {
            apiKey: "AIzaSyBOikXWOMg3uj-f_kdnXh394sVDHMtboaE",
            authDomain: "game-inventory-system.firebaseapp.com",
            projectId: "game-inventory-system",
            storageBucket: "game-inventory-system.appspot.com",
            messagingSenderId: "930027493877",
            appId: "1:930027493877:web:87974d860dae032fbea8bc"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let allPosts = [];
        let filteredPosts = [];
        let currentPage = 1;
        const postsPerPage = 10;
        let uploadedFiles = [];

        // 유틸리티 함수들
        function isAnonymousUser() {
            return currentUser && currentUser.isAnonymous;
        }

        function hasEditPermission() {
            return currentUser && !currentUser.isAnonymous;
        }

        function checkEditPermission(actionName = '이 기능') {
            if (!hasEditPermission()) {
                showNotification(`${actionName}은 정식 로그인 후 이용 가능합니다.`, 'error');
                return false;
            }
            return true;
        }

        function showNotification(message, type = 'success') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        function formatDate(timestamp) {
            if (!timestamp) return '날짜 없음';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            if (diffHours < 1) {
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                return diffMinutes < 1 ? '방금 전' : `${diffMinutes}분 전`;
            } else if (diffHours < 24) {
                return `${diffHours}시간 전`;
            } else if (diffDays < 7) {
                return `${diffDays}일 전`;
            } else {
                return date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function generateFileId() {
            return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 인증 상태 확인
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userEmailElement = document.getElementById('userEmail');
                if (userEmailElement) {
                    if (user.isAnonymous) {
                        userEmailElement.innerHTML = '🔍 게스트 사용자 <small style="color: #999;">(읽기 전용)</small>';
                    } else {
                        userEmailElement.textContent = user.email;
                    }
                }
                loadPosts();
                loadBoardStats();
            } else {
                window.location.href = 'index.html';
            }
        });

        // 게시판 통계 로드
        async function loadBoardStats() {
            try {
                const postsSnapshot = await getDocs(collection(db, 'posts'));
                const commentsSnapshot = await getDocs(collection(db, 'comments'));
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let totalPosts = 0;
                let totalComments = 0;
                let unreadPosts = 0;
                let todayPosts = 0;

                postsSnapshot.forEach(doc => {
                    const data = doc.data();
                    totalPosts++;
                    
                    // 오늘 작성된 글 계산
                    if (data.createdAt && data.createdAt.toDate) {
                        const postDate = data.createdAt.toDate();
                        if (postDate >= today) {
                            todayPosts++;
                        }
                    }
                    
                    // 읽지 않은 글 계산 (현재 사용자가 읽지 않은 글)
                    const readBy = data.readBy || [];
                    if (!readBy.includes(currentUser.uid)) {
                        unreadPosts++;
                    }
                });

                commentsSnapshot.forEach(doc => {
                    totalComments++;
                });

                document.getElementById('totalPosts').textContent = totalPosts.toLocaleString();
                document.getElementById('totalComments').textContent = totalComments.toLocaleString();
                document.getElementById('unreadPosts').textContent = unreadPosts.toLocaleString();
                document.getElementById('todayPosts').textContent = todayPosts.toLocaleString();

            } catch (error) {
                console.error('통계 로드 실패:', error);
            }
        }

        // 게시글 로드
        async function loadPosts() {
            try {
                const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                allPosts = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allPosts.push({ 
                        id: doc.id, 
                        ...data,
                        isRead: (data.readBy || []).includes(currentUser.uid)
                    });
                });
                
                filterPosts();
            } catch (error) {
                console.error('게시글 로드 실패:', error);
                showNotification('게시글 로드에 실패했습니다: ' + error.message, 'error');
                document.getElementById('postsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⚠️</div>
                        <div>게시글을 불러올 수 없습니다</div>
                    </div>
                `;
            }
        }

        // 게시글 필터링
        window.filterPosts = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            filteredPosts = allPosts.filter(post => {
                // 검색어 필터
                const matchesSearch = !searchTerm || 
                    post.title.toLowerCase().includes(searchTerm) ||
                    post.content.toLowerCase().includes(searchTerm) ||
                    post.authorName.toLowerCase().includes(searchTerm);

                // 카테고리 필터
                const matchesCategory = !categoryFilter || post.category === categoryFilter;

                // 읽음 상태 필터
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'read' && post.isRead) ||
                    (statusFilter === 'unread' && !post.isRead);

                return matchesSearch && matchesCategory && matchesStatus;
            });

            // 정렬
            switch (sortFilter) {
                case 'latest':
                    filteredPosts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    break;
                case 'oldest':
                    filteredPosts.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    break;
                case 'comments':
                    filteredPosts.sort((a, b) => (b.commentsCount || 0) - (a.commentsCount || 0));
                    break;
                case 'views':
                    filteredPosts.sort((a, b) => (b.viewCount || 0) - (a.viewCount || 0));
                    break;
            }

            currentPage = 1;
            displayPosts();
        };

        // 게시글 표시
        function displayPosts() {
            const container = document.getElementById('postsContainer');
            const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
            const startIndex = (currentPage - 1) * postsPerPage;
            const endIndex = startIndex + postsPerPage;
            const currentPosts = filteredPosts.slice(startIndex, endIndex);

            if (filteredPosts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <div>게시글이 없습니다</div>
                        <small style="margin-top: 10px; color: #666;">첫 번째 글을 작성해보세요!</small>
                    </div>
                `;
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            container.innerHTML = currentPosts.map(post => {
                const categoryEmoji = {
                    '질문': '❓',
                    '정보': '💡',
                    '자유': '💬',
                    '거래': '💰',
                    '공지': '📢'
                };

                const hasAttachments = post.attachments && post.attachments.length > 0;
                const attachmentIcon = hasAttachments ? '📎' : '';
                
                return `
                    <div class="post-item" onclick="openPostDetail('${post.id}')">
                        <div class="post-status ${post.isRead ? 'read' : 'unread'}"></div>
                        <div class="post-content">
                            <div class="post-title">
                                ${categoryEmoji[post.category] || '📄'} ${post.title}
                            </div>
                            <div class="post-meta">
                                <span>작성자: ${post.authorName}</span>
                                <span>조회: ${post.viewCount || 0}</span>
                                <span>댓글: ${post.commentsCount || 0}</span>
                                ${hasAttachments ? '<span>📎 첨부</span>' : ''}
                            </div>
                            <div class="post-preview">
                                ${post.content.replace(/<[^>]*>/g, '').substring(0, 100)}${post.content.length > 100 ? '...' : ''}
                            </div>
                        </div>
                        <div class="post-author">${post.authorName}</div>
                        <div class="post-date">${formatDate(post.createdAt)}</div>
                        <div class="post-comments">${post.commentsCount || 0}개</div>
                        <div class="post-attachments">${attachmentIcon}</div>
                    </div>
                `;
            }).join('');

            // 페이지네이션 업데이트
            updatePagination(totalPages);
        }

        // 페이지네이션 업데이트
        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // 이전 페이지
            if (currentPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="goToPage(${currentPage - 1})">‹</button>`;
            }

            // 페이지 번호들
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="page-btn" style="cursor: default; border: none; background: transparent;">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="page-btn" style="cursor: default; border: none; background: transparent;">...</span>`;
                }
                paginationHTML += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            // 다음 페이지
            if (currentPage < totalPages) {
                paginationHTML += `<button class="page-btn" onclick="goToPage(${currentPage + 1})">›</button>`;
            }

            pagination.innerHTML = paginationHTML;
        }

        // 페이지 이동
        window.goToPage = function(page) {
            currentPage = page;
            displayPosts();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // 글쓰기 모달 열기
        window.openPostModal = function() {
            if (!checkEditPermission('글쓰기')) return;
            
            document.getElementById('postModal').style.display = 'block';
            document.getElementById('postContent').focus();
        };

        // 글쓰기 모달 닫기
        window.closePostModal = function() {
            document.getElementById('postModal').style.display = 'none';
            document.getElementById('postForm').reset();
            document.getElementById('postContent').innerHTML = '';
            uploadedFiles = [];
            document.getElementById('uploadedFiles').innerHTML = '';
        };

        // 파일 업로드 관련
        document.addEventListener('DOMContentLoaded', function() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');

            // 드래그 앤 드롭
            fileUploadArea.addEventListener('click', () => fileInput.click());
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('drag-over');
            });
            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('drag-over');
            });
            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        });

        function handleFiles(files) {
            for (let file of files) {
                if (file.size > 10 * 1024 * 1024) { // 10MB 제한
                    showNotification(`파일 크기가 너무 큽니다: ${file.name} (최대 10MB)`, 'error');
                    continue;
                }

                const fileData = {
                    id: generateFileId(),
                    file: file,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: null,
                    uploaded: false
                };

                uploadedFiles.push(fileData);
                displayUploadedFile(fileData);
            }
        }

        function displayUploadedFile(fileData) {
            const container = document.getElementById('uploadedFiles');
            const fileElement = document.createElement('div');
            fileElement.className = 'uploaded-file';
            fileElement.id = `file-${fileData.id}`;

            const isImage = fileData.type.startsWith('image/');
            let previewHTML = '';

            if (isImage) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = fileElement.querySelector('.file-preview');
                    if (preview) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(fileData.file);
                previewHTML = `<img class="file-preview" style="display: none;" alt="미리보기">`;
            } else {
                previewHTML = `<div class="file-preview" style="background: #333; display: flex; align-items: center; justify-content: center; font-size: 20px;">📄</div>`;
            }

            fileElement.innerHTML = `
                <div class="file-info">
                    ${previewHTML}
                    <div class="file-details">
                        <div class="file-name">${fileData.name}</div>
                        <div class="file-size">${formatFileSize(fileData.size)}</div>
                        <div class="upload-progress" id="progress-${fileData.id}" style="display: none;">
                            <div class="upload-progress-bar" id="progress-bar-${fileData.id}"></div>
                        </div>
                        <div class="upload-status" id="status-${fileData.id}" style="font-size: 10px; color: #666;">대기 중...</div>
                    </div>
                </div>
                <button class="remove-file" onclick="removeFile('${fileData.id}')">삭제</button>
            `;

            container.appendChild(fileElement);
        }

        window.removeFile = function(fileId) {
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
            const fileElement = document.getElementById(`file-${fileId}`);
            if (fileElement) {
                fileElement.remove();
            }
        };

        // 단순한 업로드 함수 (CORS 문제 해결용)
        async function uploadFile(fileData) {
            return new Promise((resolve, reject) => {
                console.log('파일 업로드 시작:', fileData.name, fileData.size);
                
                try {
                    const storageRef = ref(storage, `posts/${fileData.id}_${fileData.name}`);
                    
                    // 진행률 표시 요소 준비
                    const progressElement = document.getElementById(`progress-${fileData.id}`);
                    const progressBar = document.getElementById(`progress-bar-${fileData.id}`);
                    const statusElement = document.getElementById(`status-${fileData.id}`);
                    
                    if (progressElement && progressBar) {
                        progressElement.style.display = 'block';
                        progressBar.style.width = '0%';
                    }
                    
                    if (statusElement) {
                        statusElement.textContent = '업로드 중...';
                        statusElement.style.color = '#00ccff';
                    }
                    
                    console.log('Storage 참조 생성 완료:', storageRef.fullPath);
                    
                    // 간단한 uploadBytes 사용 (CORS 문제 최소화)
                    uploadBytes(storageRef, fileData.file).then(async (snapshot) => {
                        console.log('파일 업로드 완료:', snapshot.metadata.name);
                        
                        try {
                            const downloadURL = await getDownloadURL(snapshot.ref);
                            console.log('다운로드 URL 획득:', downloadURL);
                            
                            fileData.url = downloadURL;
                            fileData.uploaded = true;
                            
                            if (progressBar) {
                                progressBar.style.width = '100%';
                            }
                            
                            if (statusElement) {
                                statusElement.textContent = '업로드 완료';
                                statusElement.style.color = '#00ff88';
                            }
                            
                            setTimeout(() => {
                                if (progressElement) {
                                    progressElement.style.display = 'none';
                                }
                            }, 1000);
                            
                            resolve(fileData);
                        } catch (urlError) {
                            console.error('다운로드 URL 획득 실패:', urlError);
                            if (statusElement) {
                                statusElement.textContent = 'URL 획득 실패';
                                statusElement.style.color = '#ff3333';
                            }
                            reject(urlError);
                        }
                    }).catch((uploadError) => {
                        console.error('파일 업로드 실패:', uploadError);
                        console.error('에러 코드:', uploadError.code);
                        console.error('에러 메시지:', uploadError.message);
                        
                        if (statusElement) {
                            statusElement.textContent = '업로드 실패';
                            statusElement.style.color = '#ff3333';
                        }
                        
                        // 구체적인 에러 메시지
                        let errorMessage = '';
                        switch (uploadError.code) {
                            case 'storage/unauthorized':
                                errorMessage = '파일 업로드 권한이 없습니다. 로그인 상태를 확인해주세요.';
                                break;
                            case 'storage/canceled':
                                errorMessage = '파일 업로드가 취소되었습니다.';
                                break;
                            case 'storage/unknown':
                                errorMessage = '알 수 없는 오류가 발생했습니다. CORS 설정을 확인해주세요.';
                                break;
                            case 'storage/invalid-format':
                                errorMessage = '지원하지 않는 파일 형식입니다.';
                                break;
                            case 'storage/object-not-found':
                                errorMessage = '파일을 찾을 수 없습니다.';
                                break;
                            default:
                                errorMessage = uploadError.message;
                        }
                        
                        showNotification(`업로드 실패: ${errorMessage}`, 'error');
                        reject(uploadError);
                    });
                    
                } catch (error) {
                    console.error('업로드 초기화 실패:', error);
                    if (statusElement) {
                        statusElement.textContent = '초기화 실패';
                        statusElement.style.color = '#ff3333';
                    }
                    reject(error);
                }
            });
        }

        // 텍스트 서식 기능
        window.formatText = function(command) {
            document.execCommand(command, false, null);
        };

        window.insertText = function(text) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(text));
            }
        };

        window.insertEmoji = function() {
            const emojis = ['😀', '😂', '🤔', '👍', '👎', '❤️', '🎉', '💯', '🔥', '⭐'];
            const emoji = emojis[Math.floor(Math.random() * emojis.length)];
            insertText(emoji);
        };

        // 게시글 작성 폼 처리
        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!checkEditPermission('글 작성')) return;

            const submitBtn = document.getElementById('postSubmitBtn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '📤 업로드 중...';

            try {
                console.log('업로드할 파일 수:', uploadedFiles.length);
                
                let successfulUploads = 0;
                let failedUploads = 0;
                
                if (uploadedFiles.length > 0) {
                    console.log('파일 업로드 시작...');
                    
                    // 각 파일을 순차적으로 업로드
                    for (let i = 0; i < uploadedFiles.length; i++) {
                        const fileData = uploadedFiles[i];
                        console.log(`파일 ${i + 1}/${uploadedFiles.length} 업로드 중:`, fileData.name);
                        
                        try {
                            await uploadFile(fileData);
                            successfulUploads++;
                            console.log(`파일 ${i + 1} 업로드 완료`);
                        } catch (fileError) {
                            console.error(`파일 ${i + 1} 업로드 실패:`, fileError);
                            failedUploads++;
                            
                            // 업로드 실패한 파일은 배열에서 제거하지 않음 (사용자가 다시 시도할 수 있도록)
                            fileData.uploaded = false;
                            fileData.url = null;
                        }
                    }
                    
                    console.log(`업로드 결과: 성공 ${successfulUploads}개, 실패 ${failedUploads}개`);
                    
                    if (failedUploads > 0) {
                        showNotification(`${failedUploads}개 파일 업로드에 실패했습니다. 글은 정상적으로 등록됩니다.`, 'warning');
                    }
                }

                // 게시글 데이터 준비 (업로드 성공한 파일만 포함)
                const postData = {
                    title: document.getElementById('postTitle').value.trim(),
                    content: document.getElementById('postContent').innerHTML,
                    category: document.getElementById('postCategory').value,
                    authorId: currentUser.uid,
                    authorName: currentUser.isAnonymous ? '익명' : currentUser.email.split('@')[0],
                    attachments: uploadedFiles.filter(f => f.uploaded && f.url).map(f => ({
                        id: f.id,
                        name: f.name,
                        size: f.size,
                        type: f.type,
                        url: f.url
                    })),
                    viewCount: 0,
                    commentsCount: 0,
                    readBy: [currentUser.uid],
                    createdAt: serverTimestamp()
                };

                console.log('게시글 데이터:', postData);

                // Firestore에 저장
                const docRef = await addDoc(collection(db, 'posts'), postData);
                console.log('게시글 저장 완료, ID:', docRef.id);
                
                if (successfulUploads === uploadedFiles.length) {
                    showNotification('게시글이 작성되었습니다!', 'success');
                } else if (uploadedFiles.length === 0) {
                    showNotification('게시글이 작성되었습니다!', 'success');
                } else {
                    showNotification(`게시글이 작성되었습니다! (첨부파일 ${successfulUploads}/${uploadedFiles.length}개 업로드됨)`, 'success');
                }
                
                closePostModal();
                loadPosts();
                loadBoardStats();

            } catch (error) {
                console.error('게시글 작성 실패:', error);
                showNotification('게시글 작성에 실패했습니다: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });

        // 게시글 상세보기
        window.openPostDetail = async function(postId) {
            try {
                const postDoc = await getDoc(doc(db, 'posts', postId));
                
                if (!postDoc.exists()) {
                    showNotification('게시글을 찾을 수 없습니다.', 'error');
                    return;
                }

                const postData = postDoc.data();
                
                // 조회수 증가 및 읽음 처리
                const readBy = postData.readBy || [];
                if (!readBy.includes(currentUser.uid)) {
                    await updateDoc(doc(db, 'posts', postId), {
                        viewCount: increment(1),
                        readBy: [...readBy, currentUser.uid]
                    });
                } else {
                    await updateDoc(doc(db, 'posts', postId), {
                        viewCount: increment(1)
                    });
                }

                // 댓글 로드
                const commentsQuery = query(
                    collection(db, 'comments'),
                    where('postId', '==', postId),
                    orderBy('createdAt', 'asc')
                );
                const commentsSnapshot = await getDocs(commentsQuery);
                const comments = [];
                commentsSnapshot.forEach(doc => {
                    comments.push({ id: doc.id, ...doc.data() });
                });

                // 모달 내용 생성
                const categoryEmoji = {
                    '질문': '❓',
                    '정보': '💡',
                    '자유': '💬',
                    '거래': '💰',
                    '공지': '📢'
                };

                const attachmentsHTML = postData.attachments && postData.attachments.length > 0 ? `
                    <div class="post-attachments-section">
                        <h4 style="color: #00ff88; margin-bottom: 10px;">📎 첨부파일</h4>
                        ${postData.attachments.map(attachment => {
                            const isImage = attachment.type.startsWith('image/');
                            return `
                                <div class="attachment-item">
                                    ${isImage ? 
                                        `<img class="attachment-preview" src="${attachment.url}" alt="${attachment.name}" onclick="previewImage('${attachment.url}', '${attachment.name}')">` :
                                        `<div class="attachment-preview" style="background: #333; display: flex; align-items: center; justify-content: center; font-size: 20px;">📄</div>`
                                    }
                                    <div class="attachment-info">
                                        <div class="attachment-name">${attachment.name}</div>
                                        <div class="attachment-size">${formatFileSize(attachment.size)}</div>
                                    </div>
                                    <button class="download-btn" onclick="downloadFile('${attachment.url}', '${attachment.name}')">다운로드</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : '';

                const commentsHTML = `
                    <div class="comments-section">
                        <div class="comments-header">
                            <h4 class="comments-title">💬 댓글 (${comments.length})</h4>
                        </div>
                        
                        ${hasEditPermission() ? `
                            <div class="comment-form">
                                <textarea class="comment-input" id="newCommentContent" placeholder="댓글을 입력하세요..." rows="3"></textarea>
                                <div class="comment-actions">
                                    <small style="color: #666;">Ctrl + Enter로 빠른 등록</small>
                                    <button class="btn btn-primary" onclick="addComment('${postId}')">💬 댓글 등록</button>
                                </div>
                            </div>
                        ` : '<div style="text-align: center; color: #666; padding: 20px;">댓글 작성은 정식 로그인 후 이용 가능합니다.</div>'}
                        
                        <div class="comments-list">
                            ${comments.length > 0 ? comments.map(comment => `
                                <div class="comment-item">
                                    <div class="comment-header">
                                        <span class="comment-author">${comment.authorName}</span>
                                        <span class="comment-date">${formatDate(comment.createdAt)}</span>
                                    </div>
                                    <div class="comment-content">${comment.content}</div>
                                    ${comment.authorId === currentUser.uid && hasEditPermission() ? `
                                        <div class="comment-actions-btn">
                                            <button class="btn btn-danger btn-small" onclick="deleteComment('${comment.id}', '${postId}')">삭제</button>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('') : '<div style="text-align: center; color: #666; padding: 20px;">첫 번째 댓글을 작성해보세요!</div>'}
                        </div>
                    </div>
                `;

                document.getElementById('postDetailContent').innerHTML = `
                    <div class="post-detail-header">
                        <div class="post-detail-title">
                            ${categoryEmoji[postData.category] || '📄'} ${postData.title}
                        </div>
                        <div class="post-detail-info">
                            <span>작성자: ${postData.authorName}</span>
                            <span>작성일: ${formatDate(postData.createdAt)}</span>
                            <span>조회: ${(postData.viewCount || 0) + 1}</span>
                            <span>댓글: ${comments.length}</span>
                        </div>
                    </div>
                    
                    <div class="post-detail-content">
                        ${postData.content}
                    </div>
                    
                    ${attachmentsHTML}
                    ${commentsHTML}
                `;

                document.getElementById('postDetailModal').style.display = 'block';
                
                // 데이터 새로고침
                loadPosts();
                loadBoardStats();

            } catch (error) {
                console.error('게시글 로드 실패:', error);
                showNotification('게시글을 불러올 수 없습니다: ' + error.message, 'error');
            }
        };

        // 게시글 상세보기 모달 닫기
        window.closePostDetailModal = function() {
            document.getElementById('postDetailModal').style.display = 'none';
        };

        // 댓글 추가
        window.addComment = async function(postId) {
            if (!checkEditPermission('댓글 작성')) return;

            const content = document.getElementById('newCommentContent').value.trim();
            if (!content) {
                showNotification('댓글 내용을 입력해주세요.', 'error');
                return;
            }

            try {
                // 댓글 추가
                await addDoc(collection(db, 'comments'), {
                    postId: postId,
                    content: content,
                    authorId: currentUser.uid,
                    authorName: currentUser.isAnonymous ? '익명' : currentUser.email.split('@')[0],
                    createdAt: serverTimestamp()
                });

                // 게시글의 댓글 수 증가
                await updateDoc(doc(db, 'posts', postId), {
                    commentsCount: increment(1)
                });

                showNotification('댓글이 등록되었습니다!', 'success');
                
                // 댓글 내용 초기화
                document.getElementById('newCommentContent').value = '';
                
                // 게시글 상세보기 새로고침
                openPostDetail(postId);

            } catch (error) {
                console.error('댓글 추가 실패:', error);
                showNotification('댓글 등록에 실패했습니다: ' + error.message, 'error');
            }
        };

        // 댓글 삭제
        window.deleteComment = async function(commentId, postId) {
            if (!checkEditPermission('댓글 삭제')) return;

            if (!confirm('댓글을 삭제하시겠습니까?')) return;

            try {
                await deleteDoc(doc(db, 'comments', commentId));
                await updateDoc(doc(db, 'posts', postId), {
                    commentsCount: increment(-1)
                });

                showNotification('댓글이 삭제되었습니다.', 'success');
                openPostDetail(postId);

            } catch (error) {
                console.error('댓글 삭제 실패:', error);
                showNotification('댓글 삭제에 실패했습니다: ' + error.message, 'error');
            }
        };

        // 이미지 미리보기
        window.previewImage = function(url, name) {
            document.getElementById('previewImage').src = url;
            document.getElementById('imageInfo').textContent = name;
            document.getElementById('imagePreviewModal').style.display = 'block';
        };

        window.closeImagePreview = function() {
            document.getElementById('imagePreviewModal').style.display = 'none';
        };

        // 파일 다운로드
        window.downloadFile = function(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // 모든 글 읽음 처리
        window.markAllAsRead = async function() {
            if (!hasEditPermission()) {
                showNotification('읽음 처리는 정식 로그인 후 이용 가능합니다.', 'error');
                return;
            }

            if (!confirm('모든 게시글을 읽음으로 처리하시겠습니까?')) return;

            try {
                const batch = [];
                const unreadPosts = allPosts.filter(post => !post.isRead);
                
                for (const post of unreadPosts) {
                    const readBy = post.readBy || [];
                    if (!readBy.includes(currentUser.uid)) {
                        batch.push(updateDoc(doc(db, 'posts', post.id), {
                            readBy: [...readBy, currentUser.uid]
                        }));
                    }
                }

                await Promise.all(batch);
                showNotification(`${unreadPosts.length}개 게시글을 읽음으로 처리했습니다.`, 'success');
                
                loadPosts();
                loadBoardStats();

            } catch (error) {
                console.error('읽음 처리 실패:', error);
                showNotification('읽음 처리에 실패했습니다: ' + error.message, 'error');
            }
        };

        // 댓글 입력란에서 Ctrl+Enter로 빠른 등록
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.id === 'newCommentContent') {
                        const postId = document.querySelector('.post-detail-content') ? 
                            document.querySelector('.comments-section button[onclick*="addComment"]')?.getAttribute('onclick')?.match(/addComment\('([^']+)'\)/)?.[1] : 
                            null;
                        if (postId) {
                            addComment(postId);
                        }
                    }
                }
            });
        });

        // 로그아웃 기능
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    const message = isAnonymousUser() ? 
                        '게스트 세션을 종료하시겠습니까?' : 
                        '로그아웃 하시겠습니까?';
                        
                    if (confirm(message)) {
                        import('./common.js').then(({ auth }) => {
                            import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js').then(({ signOut }) => {
                                signOut(auth).then(() => {
                                    window.location.href = 'index.html';
                                });
                            });
                        });
                    }
                });
            }
        });

        // 모달 외부 클릭시 닫기
        document.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>