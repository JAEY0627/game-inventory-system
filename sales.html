<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì„ íŒë§¤ë‚´ì—­ ê´€ë¦¬</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js" type="module"></script>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ê²Œì„ ì•„ì´í…œ ê´€ë¦¬</div>
            <div class="navigation">
                <a href="sales.html" class="nav-link active">ğŸ“Š ê²Œì„ íŒë§¤ë‚´ì—­</a>
                <a href="investment.html" class="nav-link">ğŸ’° íˆ¬ìê¸ˆ ë‚´ì—­</a>
                <a href="inventory.html" class="nav-link">ğŸ“¦ í˜„ì¬ ì¬ê³ </a>
            </div>
            <div class="user-info">
                <span id="userEmail"></span>
                <button id="logoutBtn" class="btn btn-secondary">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="content-section cyber-glow">
            <div class="section-title">
                <span>ğŸ“Š ê²Œì„ íŒë§¤ë‚´ì—­</span>
                <div class="title-buttons">
                    <button class="btn btn-success" onclick="openQuickInputModal()">âš¡ ë¹ ë¥¸ ì…ë ¥</button>
                    <button class="btn btn-primary" onclick="openSalesModal()">â• ì¶”ê°€</button>
                </div>
            </div>

            <!-- ê²€ìƒ‰ ë° í•„í„° ì„¹ì…˜ -->
            <div style="background: rgba(0, 0, 0, 0.5); border: 1px solid #333; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>ğŸ” ê²€ìƒ‰</label>
                        <input type="text" id="searchInput" placeholder="ê²Œì„ëª…, ì„œë²„ëª…ìœ¼ë¡œ ê²€ìƒ‰..." onkeyup="filterSalesData()">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“… ê¸°ê°„ í•„í„°</label>
                        <select id="periodFilter" onchange="filterSalesData()">
                            <option value="all">ì „ì²´</option>
                            <option value="today">ì˜¤ëŠ˜</option>
                            <option value="week">ìµœê·¼ 1ì£¼ì¼</option>
                            <option value="month">ìµœê·¼ 1ê°œì›”</option>
                            <option value="year">ìµœê·¼ 1ë…„</option>
                            <option value="custom">ì›”ë³„ ì„ íƒ</option>
                        </select>
                    </div>
                    <div class="form-group" id="monthFilterGroup" style="display: none;">
                        <label>ğŸ“† ë…„ì›” ì„ íƒ</label>
                        <select id="monthFilter" onchange="filterSalesData()">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                <div style="background: linear-gradient(45deg, rgba(0, 255, 136, 0.2), rgba(0, 153, 255, 0.2)); border: 2px solid #00ff88; padding: 25px; border-radius: 15px; text-align: center; position: relative; overflow: hidden;">
                    <h4 style="margin-bottom: 15px; color: #00ff88;">ğŸ’° ì´ íŒë§¤ê¸ˆì•¡</h4>
                    <div class="summary-value" id="totalSalesAmount" style="font-size: 24px; color: #00ff88;">0ì›</div>
                </div>
                <div style="background: linear-gradient(45deg, rgba(46, 213, 115, 0.2), rgba(123, 237, 159, 0.2)); border: 2px solid #2ed573; padding: 25px; border-radius: 15px; text-align: center; position: relative; overflow: hidden;">
                    <h4 style="margin-bottom: 15px; color: #2ed573;">ğŸ’³ ì´ ìˆ˜ë ¹ê¸ˆì•¡</h4>
                    <div class="summary-value" id="totalReceivedAmount" style="font-size: 24px; color: #2ed573;">0ì›</div>
                </div>
                <div style="background: linear-gradient(45deg, rgba(255, 165, 2, 0.2), rgba(255, 99, 72, 0.2)); border: 2px solid #ffa502; padding: 25px; border-radius: 15px; text-align: center; position: relative; overflow: hidden;">
                    <h4 style="margin-bottom: 15px; color: #ffa502;">ğŸ“ˆ ì´ ê±°ë˜ ìˆ˜</h4>
                    <div class="summary-value" id="totalTransactions" style="font-size: 24px; color: #ffa502;">0ê±´</div>
                </div>
                <div style="background: linear-gradient(45deg, rgba(55, 66, 250, 0.2), rgba(95, 39, 205, 0.2)); border: 2px solid #3742fa; padding: 25px; border-radius: 15px; text-align: center; position: relative; overflow: hidden;">
                    <h4 style="margin-bottom: 15px; color: #3742fa;">ğŸ“Š í‰ê·  ê±°ë˜ê¸ˆì•¡</h4>
                    <div class="summary-value" id="averageTransactionAmount" style="font-size: 24px; color: #3742fa;">0ì›</div>
                </div>
            </div>

            <div class="table-container">
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>ê²Œì„ëª…</th>
                            <th>ì„œë²„ëª…</th>
                            <th>íŒë§¤ì¼</th>
                            <th>ë‹¤ì´ì•„(ì•„ì´í…œ)ê°œìˆ˜</th>
                            <th>íŒë§¤ê¸ˆì•¡</th>
                            <th>ë§Œë‹¹(ê°œë‹¹)ê¸ˆì•¡</th>
                            <th>ìˆ˜ìˆ˜ë£Œì œì™¸ìˆ˜ë ¹</th>
                            <th>ì‘ì„±ì/ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- íŒë§¤ë‚´ì—­ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="salesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="salesModalTitle">ğŸ“Š íŒë§¤ë‚´ì—­ ì¶”ê°€</h3>
                <span class="close" onclick="closeSalesModal()">&times;</span>
            </div>
            <form id="salesForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>ê²Œì„ëª…</label>
                        <input type="text" id="gameName" placeholder="ê²Œì„ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                    <div class="form-group">
                        <label>ì„œë²„ëª…</label>
                        <input type="text" id="serverName" placeholder="ì„œë²„ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>íŒë§¤ì¼</label>
                        <input type="date" id="saleDate" required>
                    </div>
                    <div class="form-group">
                        <label>ë‹¤ì´ì•„(ì•„ì´í…œ)ê°œìˆ˜</label>
                        <input type="number" id="diamondCount" placeholder="ì•„ì´í…œ ê°œìˆ˜" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>íŒë§¤ê¸ˆì•¡</label>
                        <input type="number" id="totalPrice" placeholder="ì´ íŒë§¤ê¸ˆì•¡" required>
                    </div>
                    <div class="form-group">
                        <label>ë§Œë‹¹(ê°œë‹¹)ê¸ˆì•¡</label>
                        <input type="number" id="pricePerTenThousand" readonly style="background-color: rgba(0, 0, 0, 0.5); color: #00ff88;">
                    </div>
                </div>
                <div class="form-group">
                    <label>ìˆ˜ìˆ˜ë£Œì œì™¸ìˆ˜ë ¹</label>
                    <input type="number" id="receivedAmount" placeholder="ì‹¤ì œ ìˆ˜ë ¹ê¸ˆì•¡" required>
                </div>
                <div style="text-align: right; margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeSalesModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary" id="salesSubmitBtn">ì¶”ê°€</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë¹ ë¥¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="quickInputModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">âš¡ ë¹ ë¥¸ ì…ë ¥</h3>
                <span class="close" onclick="closeQuickInputModal()">&times;</span>
            </div>
            <div class="form-group">
                <label>ë°ì´í„° ë¶™ì—¬ë„£ê¸° (ì—¬ëŸ¬ ì¤„ ì§€ì›)</label>
                <textarea id="quickInput" rows="12" placeholder="ì—¬ëŸ¬ ì¤„ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”&#10;ì˜ˆ:&#10;ë¡œë“œë‚˜ì¸ - ë¼ë””ì–¸íŠ¸9    24ë…„ 11ì›” 28ì¼    72,000    80,000    576,000    547,200" style="font-family: 'Courier New', monospace; background: rgba(0, 0, 0, 0.7); color: #00ff88;"></textarea>
                <small style="color: #00ccff; font-size: 11px;">
                    ì—‘ì…€ì—ì„œ ì—¬ëŸ¬ í–‰ì„ ì„ íƒí•˜ì—¬ ë³µì‚¬ í›„ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥
                </small>
            </div>
            <div style="text-align: right; margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeQuickInputModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="parseQuickInput()">ìë™ ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, showNotification, checkEditPermission, hasEditPermission } from './common.js';
        import { collection, addDoc, getDocs, deleteDoc, doc, query, updateDoc, getDoc, orderBy } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        let allSalesData = [];
        let editingDocId = null;
        let editingType = null;

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
        window.loadSalesData = loadSalesData;

        // ëª¨ë‹¬ í•¨ìˆ˜ë“¤ (ê¶Œí•œ ì²´í¬ í¬í•¨)
        window.openSalesModal = function(docId = null) {
            if (!checkEditPermission('ë°ì´í„° ìˆ˜ì •')) return;
            
            if (docId) {
                editingDocId = docId;
                editingType = 'sales';
                document.getElementById('salesModalTitle').textContent = 'ğŸ“Š íŒë§¤ë‚´ì—­ ìˆ˜ì •';
                document.getElementById('salesSubmitBtn').textContent = 'ìˆ˜ì •';
                loadSalesDataForEdit(docId);
            } else {
                editingDocId = null;
                editingType = null;
                document.getElementById('salesModalTitle').textContent = 'ğŸ“Š íŒë§¤ë‚´ì—­ ì¶”ê°€';
                document.getElementById('salesSubmitBtn').textContent = 'ì¶”ê°€';
                document.getElementById('salesForm').reset();
            }
            document.getElementById('salesModal').style.display = 'block';
            
            setTimeout(() => {
                setupCalculationListeners();
            }, 100);
        };

        window.closeSalesModal = function() {
            document.getElementById('salesModal').style.display = 'none';
            document.getElementById('salesForm').reset();
            editingDocId = null;
            editingType = null;
        };

        window.openQuickInputModal = function() {
            if (!checkEditPermission('ë¹ ë¥¸ ì…ë ¥')) return;
            document.getElementById('quickInputModal').style.display = 'block';
        };

        window.closeQuickInputModal = function() {
            document.getElementById('quickInputModal').style.display = 'none';
            document.getElementById('quickInput').value = '';
        };

        // ìˆ˜ì •ìš© ë°ì´í„° ë¡œë“œ
        async function loadSalesDataForEdit(docId) {
            const docRef = doc(db, 'sales', docId);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('gameName').value = data.gameName;
                document.getElementById('serverName').value = data.serverName;
                document.getElementById('saleDate').value = data.saleDate;
                document.getElementById('diamondCount').value = data.diamondCount;
                document.getElementById('totalPrice').value = data.totalPrice;
                document.getElementById('pricePerTenThousand').value = data.pricePerTenThousand;
                document.getElementById('receivedAmount').value = data.receivedAmount;
                
                setTimeout(() => {
                    calculatePricePerItem();
                }, 100);
            }
        }

        // ì‹¤ì‹œê°„ ë§Œë‹¹ê¸ˆì•¡ ê³„ì‚°
        function calculatePricePerItem() {
            const diamondCount = parseInt(document.getElementById('diamondCount').value) || 0;
            const totalPrice = parseInt(document.getElementById('totalPrice').value) || 0;
            
            if (diamondCount > 0 && totalPrice > 0) {
                const pricePerItem = Math.round((totalPrice / diamondCount) * 10000);
                document.getElementById('pricePerTenThousand').value = pricePerItem;
            } else {
                document.getElementById('pricePerTenThousand').value = '';
            }
        }

        function setupCalculationListeners() {
            const diamondCountInput = document.getElementById('diamondCount');
            const totalPriceInput = document.getElementById('totalPrice');
            
            if (diamondCountInput && totalPriceInput) {
                diamondCountInput.removeEventListener('input', calculatePricePerItem);
                totalPriceInput.removeEventListener('input', calculatePricePerItem);
                
                diamondCountInput.addEventListener('input', calculatePricePerItem);
                totalPriceInput.addEventListener('input', calculatePricePerItem);
            }
        }

        // í¼ ì²˜ë¦¬
        document.getElementById('salesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!checkEditPermission('ë°ì´í„° ì €ì¥')) return;
            
            const diamondCount = parseInt(document.getElementById('diamondCount').value);
            const totalPrice = parseInt(document.getElementById('totalPrice').value);
            
            let pricePerTenThousand;
            if (diamondCount > 0 && totalPrice > 0) {
                pricePerTenThousand = Math.round((totalPrice / diamondCount) * 10000);
            } else {
                pricePerTenThousand = parseInt(document.getElementById('pricePerTenThousand').value) || 0;
            }
            
            const salesData = {
                userId: auth.currentUser.uid,
                userEmail: auth.currentUser.isAnonymous ? 'guest' : auth.currentUser.email.split('@')[0],
                gameName: document.getElementById('gameName').value,
                serverName: document.getElementById('serverName').value,
                saleDate: document.getElementById('saleDate').value,
                diamondCount: diamondCount,
                pricePerTenThousand: pricePerTenThousand,
                totalPrice: totalPrice,
                receivedAmount: parseInt(document.getElementById('receivedAmount').value),
                createdAt: new Date()
            };

            try {
                if (editingDocId && editingType === 'sales') {
                    await updateDoc(doc(db, 'sales', editingDocId), salesData);
                    showNotification('íŒë§¤ë‚´ì—­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } else {
                    await addDoc(collection(db, 'sales'), salesData);
                    showNotification('íŒë§¤ë‚´ì—­ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                }
                closeSalesModal();
                loadSalesData();
            } catch (error) {
                showNotification('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        });

        // ë°ì´í„° ë¡œë“œ
        async function loadSalesData() {
            try {
                const q = query(collection(db, 'sales'), orderBy('saleDate', 'desc'));
                const querySnapshot = await getDocs(q);
                
                allSalesData = [];
                querySnapshot.forEach((doc) => {
                    allSalesData.push({ id: doc.id, ...doc.data() });
                });
                
                populateMonthFilter();
                displaySalesData(allSalesData);
                updateSalesSummary(allSalesData);
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        function populateMonthFilter() {
            const monthFilter = document.getElementById('monthFilter');
            if (!monthFilter) return;
            
            monthFilter.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            const monthSet = new Set();
            allSalesData.forEach(item => {
                if (item.saleDate) {
                    const date = new Date(item.saleDate);
                    const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthSet.add(yearMonth);
                }
            });
            
            const sortedMonths = Array.from(monthSet).sort((a, b) => b.localeCompare(a));
            sortedMonths.forEach(yearMonth => {
                const [year, month] = yearMonth.split('-');
                const option = document.createElement('option');
                option.value = yearMonth;
                option.textContent = `${year}ë…„ ${parseInt(month)}ì›”`;
                monthFilter.appendChild(option);
            });
        }

        function displaySalesData(salesData) {
            const tbody = document.querySelector('#salesTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            salesData.forEach((item) => {
                const data = item;
                const row = tbody.insertRow();
                
                // ê¶Œí•œì— ë”°ë¥¸ ê´€ë¦¬ ë²„íŠ¼ í‘œì‹œ
                let actionButtons = '';
                if (hasEditPermission()) {
                    actionButtons = `
                        <button class="btn btn-warning btn-small" onclick="openSalesModal('${item.id}')">ìˆ˜ì •</button>
                        <button class="btn btn-danger btn-small" onclick="deleteSales('${item.id}')">ì‚­ì œ</button>
                    `;
                } else {
                    actionButtons = '<span style="color: #999; font-size: 12px;">ì½ê¸° ì „ìš©</span>';
                }
                
                row.innerHTML = `
                    <td>${data.gameName}</td>
                    <td>${data.serverName}</td>
                    <td>${data.saleDate}</td>
                    <td>${data.diamondCount.toLocaleString()}</td>
                    <td>${data.totalPrice.toLocaleString()}ì›</td>
                    <td>${data.pricePerTenThousand.toLocaleString()}ì›</td>
                    <td>${data.receivedAmount.toLocaleString()}ì›</td>
                    <td>
                        <span style="font-size: 12px; color: #666;">${data.userEmail || 'ìµëª…'}</span><br>
                        ${actionButtons}
                    </td>
                `;
            });
        }

        function updateSalesSummary(salesData) {
            let totalSales = 0;
            let totalReceived = 0;
            let totalTransactions = salesData.length;
            
            salesData.forEach(item => {
                totalSales += item.totalPrice || 0;
                totalReceived += item.receivedAmount || 0;
            });
            
            const averageTransaction = totalTransactions > 0 ? Math.round(totalSales / totalTransactions) : 0;
            
            const totalSalesElement = document.getElementById('totalSalesAmount');
            const totalReceivedElement = document.getElementById('totalReceivedAmount');
            const totalTransactionsElement = document.getElementById('totalTransactions');
            const averageTransactionElement = document.getElementById('averageTransactionAmount');
            
            if (totalSalesElement) totalSalesElement.textContent = totalSales.toLocaleString() + 'ì›';
            if (totalReceivedElement) totalReceivedElement.textContent = totalReceived.toLocaleString() + 'ì›';
            if (totalTransactionsElement) totalTransactionsElement.textContent = totalTransactions.toLocaleString() + 'ê±´';
            if (averageTransactionElement) averageTransactionElement.textContent = averageTransaction.toLocaleString() + 'ì›';
        }

        // ê²€ìƒ‰ ë° í•„í„°
        window.filterSalesData = function() {
            const searchInput = document.getElementById('searchInput');
            const periodFilter = document.getElementById('periodFilter');
            const monthFilter = document.getElementById('monthFilter');
            const monthFilterGroup = document.getElementById('monthFilterGroup');
            
            if (!searchInput || !periodFilter || !monthFilter || !monthFilterGroup) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const periodFilterValue = periodFilter.value;
            const monthFilterValue = monthFilter.value;
            
            if (periodFilterValue === 'custom') {
                monthFilterGroup.style.display = 'block';
            } else {
                monthFilterGroup.style.display = 'none';
                monthFilter.value = '';
            }
            
            let filteredData = allSalesData;
            
            if (searchTerm) {
                filteredData = filteredData.filter(item => 
                    item.gameName.toLowerCase().includes(searchTerm) ||
                    item.serverName.toLowerCase().includes(searchTerm)
                );
            }
            
            if (periodFilterValue !== 'all') {
                const now = new Date();
                
                filteredData = filteredData.filter(item => {
                    const itemDate = new Date(item.saleDate);
                    
                    switch (periodFilterValue) {
                        case 'today':
                            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            return itemDate >= today;
                        case 'week':
                            const weekAgo = new Date(now);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return itemDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(now);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            return itemDate >= monthAgo;
                        case 'year':
                            const yearAgo = new Date(now);
                            yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                            return itemDate >= yearAgo;
                        case 'custom':
                            if (monthFilterValue) {
                                const [filterYear, filterMonth] = monthFilterValue.split('-');
                                const itemYear = itemDate.getFullYear();
                                const itemMonth = itemDate.getMonth() + 1;
                                return itemYear == filterYear && itemMonth == filterMonth;
                            }
                            return true;
                        default:
                            return true;
                    }
                });
            }
            
            displaySalesData(filteredData);
            updateSalesSummary(filteredData);
        };

        // ì‚­ì œ í•¨ìˆ˜
        window.deleteSales = async function(docId) {
            if (!checkEditPermission('ë°ì´í„° ì‚­ì œ')) return;
            
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await deleteDoc(doc(db, 'sales', docId));
                    loadSalesData();
                    showNotification('íŒë§¤ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch (error) {
                    showNotification('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
                }
            }
        };

        // ë¹ ë¥¸ ì…ë ¥ íŒŒì‹±
        window.parseQuickInput = async function() {
            if (!checkEditPermission('ë¹ ë¥¸ ì…ë ¥')) return;
            
            const input = document.getElementById('quickInput').value.trim();
            if (!input) {
                showNotification('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const lines = input.split('\n').map(line => line.trim()).filter(line => line);
                
                if (lines.length === 0) {
                    showNotification('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                let successCount = 0;
                let errorCount = 0;

                for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
                    const line = lines[lineIndex];
                    
                    try {
                        let gameName, serverName, formattedDate, diamondCount, pricePerTenThousand, totalPrice, receivedAmount;

                        const tabSeparated = line.split('\t').map(item => item.trim()).filter(item => item);
                        
                        if (tabSeparated.length >= 6) {
                            const gameServer = tabSeparated[0];
                            const dateStr = tabSeparated[1];
                            const diamondStr = tabSeparated[2];
                            const priceStr = tabSeparated[3];
                            const totalPriceStr = tabSeparated[4];
                            const receivedAmountStr = tabSeparated[5];
                            
                            const gameServerMatch = gameServer.match(/^(.+?)\s*[-:]\s*(.+)$/);
                            if (!gameServerMatch) {
                                errorCount++;
                                continue;
                            }
                            
                            [, gameName, serverName] = gameServerMatch;
                            
                            const dateMatch = dateStr.match(/(\d{2,4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/);
                            if (!dateMatch) {
                                errorCount++;
                                continue;
                            }
                            
                            const [, year, month, day] = dateMatch;
                            const fullYear = year.length === 2 ? `20${year}` : year;
                            formattedDate = `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                            
                            if (diamondStr.includes('ì¥ì‹ êµ¬')) {
                                const match = diamondStr.match(/(\d+)/);
                                diamondCount = match ? parseInt(match[1]) : 0;
                            } else {
                                diamondCount = parseInt(diamondStr.replace(/,/g, ''));
                            }
                            
                            pricePerTenThousand = parseInt(priceStr.replace(/,/g, ''));
                            totalPrice = parseInt(totalPriceStr.replace(/,/g, ''));
                            receivedAmount = parseInt(receivedAmountStr.replace(/,/g, ''));
                        } else {
                            errorCount++;
                            continue;
                        }

                        if (isNaN(diamondCount) || isNaN(pricePerTenThousand) || isNaN(totalPrice) || isNaN(receivedAmount)) {
                            errorCount++;
                            continue;
                        }

                        const salesData = {
                            userId: auth.currentUser.uid,
                            userEmail: auth.currentUser.isAnonymous ? 'guest' : auth.currentUser.email.split('@')[0],
                            gameName: gameName.trim(),
                            serverName: serverName.trim(),
                            saleDate: formattedDate,
                            diamondCount: diamondCount,
                            pricePerTenThousand: pricePerTenThousand,
                            totalPrice: totalPrice,
                            receivedAmount: receivedAmount,
                            createdAt: new Date()
                        };

                        await addDoc(collection(db, 'sales'), salesData);
                        successCount++;

                    } catch (error) {
                        errorCount++;
                        continue;
                    }
                }

                closeQuickInputModal();
                loadSalesData();
                
                if (successCount > 0 && errorCount === 0) {
                    showNotification(`${successCount}ê°œ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰`, 'success');
                } else if (successCount > 0 && errorCount > 0) {
                    showNotification(`${successCount}ê°œ ì„±ê³µ, ${errorCount}ê°œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, 'info');
                } else {
                    showNotification(`ëª¨ë“  ë°ì´í„° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, 'error');
                }

            } catch (error) {
                showNotification('ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        };

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setupCalculationListeners();
        });
    </script>
</body>
</html>