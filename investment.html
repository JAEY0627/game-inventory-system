<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ìê¸ˆ ë‚´ì—­ ê´€ë¦¬</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js" type="module"></script>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ê²Œì„ ì•„ì´í…œ ê´€ë¦¬</div>
            <div class="navigation">
                <a href="sales.html" class="nav-link">ğŸ“Š ê²Œì„ íŒë§¤ë‚´ì—­</a>
                <a href="investment.html" class="nav-link active">ğŸ’° íˆ¬ìê¸ˆ ë‚´ì—­</a>
                <a href="inventory.html" class="nav-link">ğŸ“¦ í˜„ì¬ ì¬ê³ </a>
            </div>
            <div class="user-info">
                <span id="userEmail"></span>
                <button id="logoutBtn" class="btn btn-secondary">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="content-section">
            <div class="section-title">
                <span>ğŸ’° íˆ¬ìê¸ˆ ë‚´ì—­</span>
                <div class="title-buttons">
                    <button class="btn btn-primary" onclick="openInvestmentModal()">â• ì¶”ê°€</button>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                <label style="font-weight: 600; color: #00ccff;">ğŸ“… ì›”ë³„ ì„ íƒ:</label>
                <select id="monthSelect" style="padding: 12px; border: 2px solid #333; border-radius: 10px; font-size: 16px; background: rgba(0, 0, 0, 0.7); color: #00ff88;">
                    <option value="2025-01">2025ë…„ 1ì›”</option>
                    <option value="2025-02">2025ë…„ 2ì›”</option>
                    <option value="2025-03">2025ë…„ 3ì›”</option>
                    <option value="2025-04">2025ë…„ 4ì›”</option>
                    <option value="2025-05">2025ë…„ 5ì›”</option>
                    <option value="2025-06">2025ë…„ 6ì›”</option>
                    <option value="2025-07">2025ë…„ 7ì›”</option>
                    <option value="2025-08">2025ë…„ 8ì›”</option>
                    <option value="2025-09">2025ë…„ 9ì›”</option>
                    <option value="2025-10">2025ë…„ 10ì›”</option>
                    <option value="2025-11">2025ë…„ 11ì›”</option>
                    <option value="2025-12">2025ë…„ 12ì›”</option>
                </select>
            </div>

            <div class="table-container">
                <table id="investmentTable">
                    <thead>
                        <tr>
                            <th>íˆ¬ìì¢…ë¥˜</th>
                            <th>ê¸ˆì•¡</th>
                            <th>ë©”ëª¨</th>
                            <th>ì‘ì„±ì/ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="background: linear-gradient(45deg, rgba(0, 255, 136, 0.2), rgba(0, 153, 255, 0.2)); border: 2px solid #00ff88; color: white; padding: 25px; border-radius: 15px; margin-top: 25px; text-align: center;">
                <h3 style="margin-bottom: 15px; color: #00ff88;">ì´ë²ˆ ë‹¬ íˆ¬ìê¸ˆ ê³„</h3>
                <div style="font-size: 32px; font-weight: bold; color: #00ff88; text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);" id="investmentTotal">0ì›</div>
            </div>
        </div>
    </div>

    <!-- íˆ¬ìê¸ˆ ëª¨ë‹¬ -->
    <div id="investmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="investmentModalTitle">ğŸ’° íˆ¬ìê¸ˆ ë‚´ì—­ ì¶”ê°€</h3>
                <span class="close" onclick="closeInvestmentModal()">&times;</span>
            </div>
            <form id="investmentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>íˆ¬ìì¢…ë¥˜</label>
                        <select id="investmentType" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="êµ¬ê¸€ê¸°í”„íŠ¸ì¹´ë“œ">êµ¬ê¸€ê¸°í”„íŠ¸ì¹´ë“œ</option>
                            <option value="ì‚¬ì „ì¿ í°êµ¬ë§¤(ë¦°M)">ì‚¬ì „ì¿ í°êµ¬ë§¤(ë¦°M)</option>
                            <option value="ì „ê¸°ì„¸">ì „ê¸°ì„¸</option>
                            <option value="ì¸í„°ë„·ë¹„ìš©">ì¸í„°ë„·ë¹„ìš©</option>
                            <option value="í”„ë¡œê·¸ë¨(ë³´ì•ˆ)ë¹„ìš©">í”„ë¡œê·¸ë¨(ë³´ì•ˆ)ë¹„ìš©</option>
                            <option value="ëˆ„ë‚˜ì •ì‚°">ëˆ„ë‚˜ì •ì‚°</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê¸ˆì•¡</label>
                        <input type="number" id="investmentAmount" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>ë©”ëª¨</label>
                    <input type="text" id="investmentMemo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div style="text-align: right; margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeInvestmentModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary" id="investmentSubmitBtn">ì¶”ê°€</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { auth, db, showNotification, checkEditPermission, hasEditPermission } from './common.js';
        import { collection, addDoc, getDocs, deleteDoc, doc, query, where, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        let currentMonth = '2025-06';
        let editingDocId = null;
        let editingType = null;

        const monthSelect = document.getElementById('monthSelect');

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
        window.loadInvestmentData = loadInvestmentData;

        // í˜„ì¬ ì›”ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        const now = new Date();
        const currentMonthValue = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        monthSelect.value = currentMonthValue;
        currentMonth = currentMonthValue;

        // ì›” ì„ íƒ ë³€ê²½
        monthSelect.addEventListener('change', (e) => {
            currentMonth = e.target.value;
            loadInvestmentData();
        });

        // ëª¨ë‹¬ í•¨ìˆ˜ë“¤ (ê¶Œí•œ ì²´í¬ í¬í•¨)
        window.openInvestmentModal = function(docId = null) {
            if (!checkEditPermission('íˆ¬ìê¸ˆ ë‚´ì—­ ê´€ë¦¬')) return;
            
            if (docId) {
                editingDocId = docId;
                editingType = 'investment';
                document.getElementById('investmentModalTitle').textContent = 'ğŸ’° íˆ¬ìê¸ˆ ë‚´ì—­ ìˆ˜ì •';
                document.getElementById('investmentSubmitBtn').textContent = 'ìˆ˜ì •';
                loadInvestmentDataForEdit(docId);
            } else {
                editingDocId = null;
                editingType = null;
                document.getElementById('investmentModalTitle').textContent = 'ğŸ’° íˆ¬ìê¸ˆ ë‚´ì—­ ì¶”ê°€';
                document.getElementById('investmentSubmitBtn').textContent = 'ì¶”ê°€';
                document.getElementById('investmentForm').reset();
            }
            document.getElementById('investmentModal').style.display = 'block';
        };

        window.closeInvestmentModal = function() {
            document.getElementById('investmentModal').style.display = 'none';
            document.getElementById('investmentForm').reset();
            editingDocId = null;
            editingType = null;
        };

        // ìˆ˜ì •ìš© ë°ì´í„° ë¡œë“œ
        async function loadInvestmentDataForEdit(docId) {
            const docRef = doc(db, 'investments', docId);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('investmentType').value = data.type;
                document.getElementById('investmentAmount').value = data.amount;
                document.getElementById('investmentMemo').value = data.memo;
            }
        }

        // í¼ ì²˜ë¦¬
        document.getElementById('investmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!checkEditPermission('íˆ¬ìê¸ˆ ë‚´ì—­ ì €ì¥')) return;
            
            const investmentData = {
                userId: auth.currentUser.uid,
                userEmail: auth.currentUser.isAnonymous ? 'guest' : auth.currentUser.email.split('@')[0],
                month: currentMonth,
                type: document.getElementById('investmentType').value,
                amount: parseInt(document.getElementById('investmentAmount').value),
                memo: document.getElementById('investmentMemo').value,
                createdAt: new Date()
            };

            try {
                if (editingDocId && editingType === 'investment') {
                    await updateDoc(doc(db, 'investments', editingDocId), investmentData);
                    showNotification('íˆ¬ìê¸ˆ ë‚´ì—­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    await addDoc(collection(db, 'investments'), investmentData);
                    showNotification('íˆ¬ìê¸ˆ ë‚´ì—­ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
                closeInvestmentModal();
                loadInvestmentData();
            } catch (error) {
                showNotification('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        });

        // ë°ì´í„° ë¡œë“œ
        async function loadInvestmentData() {
            try {
                const q = query(collection(db, 'investments'), where('month', '==', currentMonth));
                const querySnapshot = await getDocs(q);
                
                const tbody = document.querySelector('#investmentTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let total = 0;
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    total += data.amount;
                    
                    // ê¶Œí•œì— ë”°ë¥¸ ê´€ë¦¬ ë²„íŠ¼ í‘œì‹œ
                    let actionButtons = '';
                    if (hasEditPermission()) {
                        actionButtons = `
                            <button class="btn btn-warning btn-small" onclick="openInvestmentModal('${doc.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-small" onclick="deleteInvestment('${doc.id}')">ì‚­ì œ</button>
                        `;
                    } else {
                        actionButtons = '<span style="color: #999; font-size: 12px;">ì½ê¸° ì „ìš©</span>';
                    }
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${data.type}</td>
                        <td>${data.amount.toLocaleString()}ì›</td>
                        <td>${data.memo}</td>
                        <td>
                            <span style="font-size: 12px; color: #666;">${data.userEmail || 'ìµëª…'}</span><br>
                            ${actionButtons}
                        </td>
                    `;
                });
                
                const totalElement = document.getElementById('investmentTotal');
                if (totalElement) {
                    totalElement.textContent = total.toLocaleString() + 'ì›';
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ì‚­ì œ í•¨ìˆ˜
        window.deleteInvestment = async function(docId) {
            if (!checkEditPermission('íˆ¬ìê¸ˆ ë‚´ì—­ ì‚­ì œ')) return;
            
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await deleteDoc(doc(db, 'investments', docId));
                    loadInvestmentData();
                    showNotification('íˆ¬ìê¸ˆ ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch (error) {
                    showNotification('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
                }
            }
        };
    </script>
</body>
</html>