<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게임 아이템 관리 - 메인 대시보드</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js" type="module"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="common.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 
                0 0 20px rgba(0, 255, 136, 0.3),
                inset 0 0 20px rgba(0, 255, 136, 0.1);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(0, 255, 136, 0.1), transparent);
            animation: cardShine 4s linear infinite;
            pointer-events: none;
        }

        @keyframes cardShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .card-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 15px;
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .card-title {
            font-size: 16px;
            font-weight: bold;
            color: #00ff88;
            text-align: center;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #00ff88;
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.8);
            margin-bottom: 8px;
            word-break: break-all;
        }

        .card-subtitle {
            font-size: 12px;
            text-align: center;
            color: #00ccff;
            opacity: 0.8;
        }

        .chart-container {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 
                0 0 20px rgba(0, 255, 136, 0.3),
                inset 0 0 20px rgba(0, 255, 136, 0.1);
            overflow: hidden;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #00ff88;
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
        }

        .recent-section {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 
                0 0 20px rgba(0, 255, 136, 0.3),
                inset 0 0 20px rgba(0, 255, 136, 0.1);
        }

        .recent-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .recent-item:hover {
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .recent-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .recent-item-title {
            font-weight: bold;
            color: #00ff88;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .recent-item-amount {
            color: #00ccff;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .recent-item-date {
            font-size: 12px;
            color: #666;
        }

        .profit-card {
            border-color: #ff0099 !important;
        }

        .profit-card .card-title,
        .profit-card .card-value {
            color: #ff0099 !important;
            text-shadow: 0 0 15px rgba(255, 0, 153, 0.8) !important;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .game-chart-container {
            position: relative;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 769px) {
            .chart-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top: 2px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 업데이트 표시 스타일 */
        .updated-indicator {
            display: inline-block;
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
            border: 1px solid #ffaa00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">게임 아이템 관리</div>
            <div class="navigation">
                <a href="main.html" class="nav-link active">🏠 메인 대시보드</a>
                <a href="sales.html" class="nav-link">📊 게임 판매내역</a>
                <a href="investment.html" class="nav-link">💰 투자금 내역</a>
                <a href="inventory.html" class="nav-link">📦 현재 재고</a>
            </div>
            <div class="user-info">
                <span id="userEmail"></span>
                <button id="logoutBtn" class="btn btn-secondary">로그아웃</button>
            </div>
        </div>

        <div class="content-section cyber-glow">
            <div class="section-title">
                <span>🎮 메인 대시보드</span>
                <div class="title-buttons">
                    <button class="btn btn-primary" onclick="refreshDashboard()">🔄 새로고침</button>
                </div>
            </div>

            <!-- 주요 지표 카드들 -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-icon">💰</div>
                    <div class="card-title">총 판매금액</div>
                    <div class="card-value" id="totalSalesValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">누적 판매 수익</div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">💳</div>
                    <div class="card-title">총 수령금액</div>
                    <div class="card-value" id="totalReceivedValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">실제 받은 금액</div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">💸</div>
                    <div class="card-title">총 투자금액</div>
                    <div class="card-value" id="totalInvestmentValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">누적 투자 비용</div>
                </div>

                <div class="dashboard-card profit-card">
                    <div class="card-icon">📈</div>
                    <div class="card-title">순이익</div>
                    <div class="card-value" id="totalProfitValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">수령금액 - 투자금액</div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">📊</div>
                    <div class="card-title">총 거래 건수</div>
                    <div class="card-value" id="totalTransactionsValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">총 판매 횟수</div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">💎</div>
                    <div class="card-title">현재 재고</div>
                    <div class="card-value" id="totalInventoryValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">보유 다이아 총량</div>
                </div>
            </div>

            <!-- 차트 섹션 -->
            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-title">📈 월별 판매 추이</div>
                    <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="monthlySalesChart" style="max-width: 100%; max-height: 100%;"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">💰 월별 수익 비교</div>
                    <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="monthlyProfitChart" style="max-width: 100%; max-height: 100%;"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">🎮 게임별 판매 현황</div>
                <div class="game-chart-container">
                    <canvas id="gameStatsChart" width="350" height="350"></canvas>
                </div>
            </div>

            <!-- 최근 활동 섹션 -->
            <div class="recent-section">
                <div class="section-title">
                    <span>🕒 최근 활동</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr; gap: 25px;">
                    <div>
                        <h4 style="color: #00ff88; margin-bottom: 15px;">최근 판매 (판매일 기준 5건)</h4>
                        <div id="recentSales"></div>
                    </div>
                    
                    <div>
                        <h4 style="color: #00ff88; margin-bottom: 15px;">최근 투자 (월별 기준 5건)</h4>
                        <div id="recentInvestments"></div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h4 style="color: #ff0099; margin-bottom: 15px;">📋 전체 최근 활동 (등록/수정 시간 기준 10건)</h4>
                    <div id="recentActivities"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, orderBy, limit, where } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getUserGameFilter, shouldFilterByGame } from './common.js';
        
        // Firebase 초기화
        const firebaseConfig = {
            apiKey: "AIzaSyBOikXWOMg3uj-f_kdnXh394sVDHMtboaE",
            authDomain: "game-inventory-system.firebaseapp.com",
            projectId: "game-inventory-system",
            storageBucket: "game-inventory-system.appspot.com",
            messagingSenderId: "930027493877",
            appId: "1:930027493877:web:87974d860dae032fbea8bc"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let salesChart, profitChart, gameChart;
        let currentUser = null;

        // 유틸리티 함수들
        function isAnonymousUser() {
            return currentUser && currentUser.isAnonymous;
        }

        function showNotification(message, type = 'success') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // 인증 상태 확인
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userEmailElement = document.getElementById('userEmail');
                if (userEmailElement) {
                    if (user.isAnonymous) {
                        userEmailElement.innerHTML = '🔍 게스트 사용자 <small style="color: #999;">(읽기 전용)</small>';
                    } else {
                        userEmailElement.textContent = user.email;
                    }
                }
                setTimeout(loadDashboardData, 500);
            } else {
                window.location.href = 'index.html';
            }
        });

        // 로그아웃 처리
        document.getElementById('logoutBtn').addEventListener('click', () => {
            const message = isAnonymousUser() ? 
                '게스트 세션을 종료하시겠습니까?' : 
                '로그아웃 하시겠습니까?';
                
            if (confirm(message)) {
                signOut(auth).then(() => {
                    window.location.href = 'index.html';
                });
            }
        });

        // 전역 함수로 등록
        window.refreshDashboard = refreshDashboard;
        window.loadDashboardData = loadDashboardData;

        // 대시보드 데이터 로드
        async function loadDashboardData() {
            try {
                const userGameFilter = getUserGameFilter(auth.currentUser.email);
        
                // 모든 데이터 동시 로드
                let salesQuery, inventoryQuery;
                
                if (userGameFilter) {
                    salesQuery = query(
                        collection(db, 'sales'),
                        where('gameName', '==', userGameFilter)
                    );
                    inventoryQuery = query(
                        collection(db, 'inventory'),
                        where('gameName', '==', userGameFilter)
                    );
                } else {
                    salesQuery = collection(db, 'sales');
                    inventoryQuery = collection(db, 'inventory');
                }
                
                const [salesData, investmentData, inventoryData] = await Promise.all([
                    getDocs(salesQuery),
                    getDocs(collection(db, 'investments')), // 투자는 게임별 필터링 안함
                    getDocs(inventoryQuery)
                ]);
                // 판매 데이터 처리
                const sales = [];
                let totalSales = 0;
                let totalReceived = 0;
                let totalTransactions = 0;

                salesData.forEach(doc => {
                    const data = doc.data();
                    sales.push(data);
                    totalSales += data.totalPrice || 0;
                    totalReceived += data.receivedAmount || 0;
                    totalTransactions++;
                });

                // 투자 데이터 처리
                const investments = [];
                let totalInvestment = 0;

                investmentData.forEach(doc => {
                    const data = doc.data();
                    investments.push(data);
                    totalInvestment += data.amount || 0;
                });

                // 재고 데이터 처리
                const inventory = [];
                let totalInventory = 0;
                inventoryData.forEach(doc => {
                    const data = doc.data();
                    inventory.push(data);
                    totalInventory += data.diamondCount || 0;
                });

                // 순이익 계산
                const totalProfit = totalReceived - totalInvestment;

                // UI 업데이트
                updateDashboardCards({
                    totalSales,
                    totalReceived,
                    totalInvestment,
                    totalProfit,
                    totalTransactions,
                    totalInventory
                });

                // 차트 업데이트
                updateCharts(sales, investments);

                // 최근 활동 업데이트 (재고 데이터도 전달)
                updateRecentActivities(sales, investments, inventory);

            } catch (error) {
                console.error('대시보드 데이터 로드 실패:', error);
                showNotification('데이터 로드 실패: ' + error.message, 'error');
            }
        }

        // 대시보드 카드 업데이트
        function updateDashboardCards(data) {
            document.getElementById('totalSalesValue').textContent = data.totalSales.toLocaleString() + '원';
            document.getElementById('totalReceivedValue').textContent = data.totalReceived.toLocaleString() + '원';
            document.getElementById('totalInvestmentValue').textContent = data.totalInvestment.toLocaleString() + '원';
            document.getElementById('totalProfitValue').textContent = data.totalProfit.toLocaleString() + '원';
            document.getElementById('totalTransactionsValue').textContent = data.totalTransactions.toLocaleString() + '건';
            document.getElementById('totalInventoryValue').textContent = data.totalInventory.toLocaleString() + '개';

            // 순이익이 음수면 빨간색으로 표시
            const profitElement = document.getElementById('totalProfitValue');
            if (data.totalProfit < 0) {
                profitElement.style.color = '#ff3333';
                profitElement.style.textShadow = '0 0 15px rgba(255, 51, 51, 0.8)';
            }
        }

        // 차트 업데이트
        function updateCharts(salesData, investmentData) {
            // 월별 데이터 집계
            const monthlyData = {};

            // 판매 데이터 집계
            salesData.forEach(item => {
                if (item.saleDate) {
                    const date = new Date(item.saleDate);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    // 월 데이터가 없으면 생성
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            sales: 0,
                            received: 0,
                            investment: 0,
                            transactions: 0
                        };
                    }
                    
                    monthlyData[monthKey].sales += item.totalPrice || 0;
                    monthlyData[monthKey].received += item.receivedAmount || 0;
                    monthlyData[monthKey].transactions++;
                }
            });

            // 투자 데이터 집계
            investmentData.forEach(item => {
                if (item.investmentDate) {  // item.month 대신 item.investmentDate 사용
                    const date = new Date(item.investmentDate);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    // 월 데이터가 없으면 생성
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            sales: 0,
                            received: 0,
                            investment: 0,
                            transactions: 0
                        };
                    }
                    
                    monthlyData[monthKey].investment += item.amount || 0;
                }
            });

            // 게임별 데이터 집계
            const gameData = {};
            salesData.forEach(item => {
                const gameName = item.gameName || '기타';
                if (!gameData[gameName]) {
                    gameData[gameName] = {
                        sales: 0,
                        transactions: 0
                    };
                }
                gameData[gameName].sales += item.totalPrice || 0;
                gameData[gameName].transactions++;
            });

            // 차트 생성 전에 월별 데이터를 정렬된 순서로 재구성
            const sortedMonthKeys = Object.keys(monthlyData).sort();
            const sortedMonthlyData = {};

            sortedMonthKeys.forEach(key => {
                sortedMonthlyData[key] = monthlyData[key];
            });

            // 차트 생성/업데이트
            createMonthlySalesChart(sortedMonthlyData);
            createMonthlyProfitChart(sortedMonthlyData);
            createGameStatsChart(gameData);
        }

        // 월별 판매 차트
        function createMonthlySalesChart(sortedMonthlyData) {
            const ctx = document.getElementById('monthlySalesChart').getContext('2d');
            
            if (salesChart) {
                salesChart.destroy();
            }

            const months = Object.keys(sortedMonthlyData).map(key => {
                const [year, month] = key.split('-');
                return `${month}월`;
            });

            // 수정 (만원 단위로 변환)
            const salesValues = Object.values(sortedMonthlyData).map(data => Math.round(data.sales / 10000));
            const transactionCounts = Object.values(sortedMonthlyData).map(data => data.transactions);

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: '판매금액',
                        data: salesValues,
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: '거래건수',
                        data: transactionCounts,
                        borderColor: '#ff0099',
                        backgroundColor: 'rgba(255, 0, 153, 0.1)',
                        borderWidth: 2,
                        type: 'bar',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#00ff88'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#00ccff' },
                            grid: { color: 'rgba(0, 255, 136, 0.1)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { 
                                color: '#00ff88',
                                callback: function(value) {
                                    return value.toLocaleString() + '만원';
                                }
                            },
                            grid: { color: 'rgba(0, 255, 136, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { 
                                color: '#ff0099',
                                callback: function(value) {
                                    return value + '건';
                                }
                            },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // 월별 수익 비교 차트
        function createMonthlyProfitChart(sortedMonthlyData) {
            const ctx = document.getElementById('monthlyProfitChart').getContext('2d');
            
            if (profitChart) {
                profitChart.destroy();
            }

            const months = Object.keys(sortedMonthlyData).map(key => {
                const [year, month] = key.split('-');
                return `${month}월`;
            });

            const receivedValues = Object.values(sortedMonthlyData).map(data => Math.round(data.received / 10000));
            const investmentValues = Object.values(sortedMonthlyData).map(data => Math.round(data.investment / 10000));

            profitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: '수령금액',
                        data: receivedValues,
                        backgroundColor: 'rgba(0, 255, 136, 0.7)',
                        borderColor: '#00ff88',
                        borderWidth: 2
                    }, {
                        label: '투자금액',
                        data: investmentValues,
                        backgroundColor: 'rgba(255, 0, 153, 0.7)',
                        borderColor: '#ff0099',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#00ff88'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#00ccff' },
                            grid: { color: 'rgba(0, 255, 136, 0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: '#00ff88',
                                callback: function(value) {
                                    return value.toLocaleString() + '만원';
                                }
                            },
                            grid: { color: 'rgba(0, 255, 136, 0.1)' }
                        }
                    }
                }
            });
        }

        // 게임별 통계 차트
        function createGameStatsChart(gameData) {
            const ctx = document.getElementById('gameStatsChart').getContext('2d');
            
            if (gameChart) {
                gameChart.destroy();
            }

            const gameNames = Object.keys(gameData);
            const gameSales = Object.values(gameData).map(data => data.sales);
            const totalSales = gameSales.reduce((sum, value) => sum + value, 0);

            // 퍼센티지 계산
            const gameLabelsWithPercentage = gameNames.map((name, index) => {
                const percentage = totalSales > 0 ? Math.round((gameSales[index] / totalSales) * 100) : 0;
                return `${name} (${percentage}%)`;
            });

            // 랜덤 색상 생성
            const colors = gameNames.map(() => {
                const hue = Math.random() * 360;
                return `hsl(${hue}, 70%, 60%)`;
            });

            gameChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: gameLabelsWithPercentage,
                    datasets: [{
                        data: gameSales,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('60%', '80%')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#00ff88',
                                padding: 15,
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    return `${label}: ${value.toLocaleString()}원`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 최근 활동 업데이트 (updatedAt 우선 처리)
        async function updateRecentActivities(salesData, investmentData, inventoryData) {
            // 최근 판매 5건 (판매일 기준으로 정렬)
            const recentSales = salesData
                .filter(item => item.saleDate) // 판매일이 있는 것만
                .sort((a, b) => {
                    const dateA = new Date(a.saleDate);
                    const dateB = new Date(b.saleDate);
                    return dateB - dateA; // 최신 판매일 순
                })
                .slice(0, 5);

            const recentSalesHtml = recentSales.map(item => {
                const createdDate = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt || 0);
                const formattedDate = createdDate.toLocaleDateString('ko-KR', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="recent-item">
                        <div class="recent-item-header">
                            <span class="recent-item-title">${item.gameName} - ${item.serverName}</span>
                            <span class="recent-item-amount">${item.totalPrice?.toLocaleString() || 0}원</span>
                        </div>
                        <div class="recent-item-date">📅 ${item.saleDate} | ⏰ ${formattedDate}</div>
                    </div>
                `;
            }).join('');

            // 최근 투자 5건 (월별 기준으로 정렬)
            const recentInvestments = investmentData
                .sort((a, b) => {
                    // 투자일 기준으로 정렬 (최신 순)
                    if (a.investmentDate !== b.investmentDate) {
                        return (b.investmentDate || '').localeCompare(a.investmentDate || '');
                    }
                    // 같은 날이면 등록일 기준
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateB - dateA;
                })
                .slice(0, 5);

            const recentInvestmentsHtml = recentInvestments.map(item => {
                const createdDate = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt || 0);
                const formattedDate = createdDate.toLocaleDateString('ko-KR', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // investmentDate를 사용하여 날짜 표시
                const investmentDateText = item.investmentDate ? 
                    new Date(item.investmentDate).toLocaleDateString('ko-KR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : '날짜 미상';
                
                return `
                    <div class="recent-item">
                        <div class="recent-item-header">
                            <span class="recent-item-title">${item.type || '투자'}</span>
                            <span class="recent-item-amount">${item.amount?.toLocaleString() || 0}원</span>
                        </div>
                        <div class="recent-item-date">📅 ${investmentDateText} | 📝 ${item.memo || ''} | ⏰ ${formattedDate}</div>
                    </div>
                `;
            }).join('');

            // 전체 최근 활동 10건 (판매, 투자, 재고 모든 데이터 포함, 최신 시간 기준)
            const allActivities = [];
            
            // 판매 데이터 추가
            salesData.forEach(item => {
                const createdDate = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt || 0);
                allActivities.push({
                    type: 'sale',
                    title: `🛒 ${item.gameName} - ${item.serverName}`,
                    amount: item.totalPrice || 0,
                    detail: `판매일: ${item.saleDate || '미상'} | 다이아: ${(item.diamondCount || 0).toLocaleString()}개`,
                    createdAt: createdDate,
                    isUpdated: false
                });
            });
            
            // 투자 데이터 추가
            investmentData.forEach(item => {
                const createdDate = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt || 0);
                const investmentDateText = item.investmentDate ? 
                    new Date(item.investmentDate).toLocaleDateString('ko-KR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : '날짜 미상';
                
                allActivities.push({
                    type: 'investment',
                    title: `💰 ${item.type || '투자'}`,
                    amount: item.amount || 0,
                    detail: `${investmentDateText} | ${item.memo || '메모 없음'}`,
                    createdAt: createdDate,
                    isUpdated: false
                });
            });

            // 재고 데이터 추가 (updatedAt 우선, 없으면 createdAt 사용)
            inventoryData.forEach(item => {
                // updatedAt과 createdAt 비교하여 실제 수정 여부 판단
                let activityDate;
                let isUpdated = false;
                
                const createdDate = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt || 0);
                const updatedDate = item.updatedAt?.toDate ? item.updatedAt.toDate() : null;
                
                if (updatedDate && updatedDate > createdDate) {
                    // updatedAt이 createdAt보다 나중이면 실제 수정된 것
                    activityDate = updatedDate;
                    isUpdated = true;
                } else {
                    // updatedAt이 없거나 createdAt과 같으면 최초 생성
                    activityDate = createdDate;
                    isUpdated = false;
                }
                
                allActivities.push({
                    type: 'inventory',
                    title: `📦 ${item.gameName} - ${item.serverName}`,
                    amount: item.diamondCount || 0,
                    detail: `${item.computerName} | ${item.accountName}`,
                    createdAt: activityDate,
                    isUpdated: isUpdated
                });
            });
            
            // 최신 시간 기준으로 정렬하고 10건만
            const recentActivitiesSorted = allActivities
                .sort((a, b) => b.createdAt - a.createdAt)
                .slice(0, 10);
            
            const recentActivitiesHtml = recentActivitiesSorted.map(item => {
                const formattedDate = item.createdAt.toLocaleDateString('ko-KR', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let amountColor, amountSign, amountText;
                
                if (item.type === 'sale') {
                    amountColor = '#00ff88';
                    amountSign = '+';
                    amountText = `${item.amount.toLocaleString()}원`;
                } else if (item.type === 'investment') {
                    amountColor = '#ff0099';
                    amountSign = '-';
                    amountText = `${item.amount.toLocaleString()}원`;
                } else { // inventory
                    amountColor = '#00ccff';
                    amountSign = '';
                    amountText = `${item.amount.toLocaleString()}개`;
                }
                
                // 업데이트된 항목에 표시 추가
                const updatedIndicator = item.isUpdated ? '<span class="updated-indicator">수정됨</span>' : '';
                
                return `
                    <div class="recent-item">
                        <div class="recent-item-header">
                            <span class="recent-item-title">${item.title}${updatedIndicator}</span>
                            <span class="recent-item-amount" style="color: ${amountColor};">${amountSign}${amountText}</span>
                        </div>
                        <div class="recent-item-date">${item.detail} | ⏰ ${formattedDate}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('recentSales').innerHTML = recentSalesHtml || '<div style="color: #666; text-align: center; padding: 20px;">판매 내역이 없습니다.</div>';
            document.getElementById('recentInvestments').innerHTML = recentInvestmentsHtml || '<div style="color: #666; text-align: center; padding: 20px;">투자 내역이 없습니다.</div>';
            document.getElementById('recentActivities').innerHTML = recentActivitiesHtml || '<div style="color: #666; text-align: center; padding: 20px;">활동 내역이 없습니다.</div>';
        }

        // 새로고침 함수
        function refreshDashboard() {
            showNotification('대시보드를 새로고침하는 중...', 'info');
            
            // 로딩 스피너 표시
            const valueElements = ['totalSalesValue', 'totalReceivedValue', 'totalInvestmentValue', 'totalProfitValue', 'totalTransactionsValue', 'totalInventoryValue'];
            valueElements.forEach(id => {
                document.getElementById(id).innerHTML = '<span class="loading-spinner"></span>';
            });

            loadDashboardData().then(() => {
                showNotification('대시보드가 업데이트되었습니다!', 'success');
            });
        }
    </script>
</body>
</html>