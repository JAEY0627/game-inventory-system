<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì„ ì•„ì´í…œ ê´€ë¦¬ - ë©”ì¸ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js" type="module"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="common.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 
                0 0 20px rgba(0, 255, 136, 0.3),
                inset 0 0 20px rgba(0, 255, 136, 0.1);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(0, 255, 136, 0.1), transparent);
            animation: cardShine 4s linear infinite;
            pointer-events: none;
        }

        @keyframes cardShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .card-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 15px;
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .card-title {
            font-size: 16px;
            font-weight: bold;
            color: #00ff88;
            text-align: center;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #00ff88;
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.8);
            margin-bottom: 8px;
            word-break: break-all;
        }

        .card-subtitle {
            font-size: 12px;
            text-align: center;
            color: #00ccff;
            opacity: 0.8;
        }

        .chart-container {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 
                0 0 20px rgba(0, 255, 136, 0.3),
                inset 0 0 20px rgba(0, 255, 136, 0.1);
            overflow: hidden;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #00ff88;
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
        }

        .recent-section {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 
                0 0 20px rgba(0, 255, 136, 0.3),
                inset 0 0 20px rgba(0, 255, 136, 0.1);
        }

        .recent-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .recent-item:hover {
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .recent-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .recent-item-title {
            font-weight: bold;
            color: #00ff88;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .recent-item-amount {
            color: #00ccff;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .recent-item-date {
            font-size: 12px;
            color: #666;
        }

        .profit-card {
            border-color: #ff0099 !important;
        }

        .profit-card .card-title,
        .profit-card .card-value {
            color: #ff0099 !important;
            text-shadow: 0 0 15px rgba(255, 0, 153, 0.8) !important;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .game-chart-container {
            position: relative;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 769px) {
            .chart-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top: 2px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ì—…ë°ì´íŠ¸ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .updated-indicator {
            display: inline-block;
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
            border: 1px solid #ffaa00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ê²Œì„ ì•„ì´í…œ ê´€ë¦¬</div>
            <div class="navigation">
                <a href="main.html" class="nav-link active">ğŸ  ë©”ì¸ ëŒ€ì‹œë³´ë“œ</a>
                <a href="sales.html" class="nav-link">ğŸ“Š ê²Œì„ íŒë§¤ë‚´ì—­</a>
                <a href="investment.html" class="nav-link">ğŸ’° íˆ¬ìê¸ˆ ë‚´ì—­</a>
                <a href="inventory.html" class="nav-link">ğŸ“¦ í˜„ì¬ ì¬ê³ </a>
            </div>
            <div class="user-info">
                <span id="userEmail"></span>
                <button id="logoutBtn" class="btn btn-secondary">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="content-section cyber-glow">
            <div class="section-title">
                <span>ğŸ® ë©”ì¸ ëŒ€ì‹œë³´ë“œ</span>
                <div class="title-buttons">
                    <button class="btn btn-primary" onclick="refreshDashboard()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>

            <!-- ì£¼ìš” ì§€í‘œ ì¹´ë“œë“¤ -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-icon">ğŸ’°</div>
                    <div class="card-title">ì´ íŒë§¤ê¸ˆì•¡</div>
                    <div class="card-value" id="totalSalesValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">ëˆ„ì  íŒë§¤ ìˆ˜ìµ</div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">ğŸ’³</div>
                    <div class="card-title">ì´ ìˆ˜ë ¹ê¸ˆì•¡</div>
                    <div class="card-value" id="totalReceivedValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">ì‹¤ì œ ë°›ì€ ê¸ˆì•¡</div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">ğŸ’¸</div>
                    <div class="card-title">ì´ íˆ¬ìê¸ˆì•¡</div>
                    <div class="card-value" id="totalInvestmentValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">ëˆ„ì  íˆ¬ì ë¹„ìš©</div>
                </div>

                <div class="dashboard-card profit-card">
                    <div class="card-icon">ğŸ“ˆ</div>
                    <div class="card-title">ìˆœì´ìµ</div>
                    <div class="card-value" id="totalProfitValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">ìˆ˜ë ¹ê¸ˆì•¡ - íˆ¬ìê¸ˆì•¡</div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">ğŸ“Š</div>
                    <div class="card-title">ì´ ê±°ë˜ ê±´ìˆ˜</div>
                    <div class="card-value" id="totalTransactionsValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">ì´ íŒë§¤ íšŸìˆ˜</div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">ğŸ’</div>
                    <div class="card-title">í˜„ì¬ ì¬ê³ </div>
                    <div class="card-value" id="totalInventoryValue">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="card-subtitle">ë³´ìœ  ë‹¤ì´ì•„ ì´ëŸ‰</div>
                </div>
            </div>

            <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-title">ğŸ“ˆ ì›”ë³„ íŒë§¤ ì¶”ì´</div>
                    <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="monthlySalesChart" style="max-width: 100%; max-height: 100%;"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">ğŸ’° ì›”ë³„ ìˆ˜ìµ ë¹„êµ</div>
                    <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="monthlyProfitChart" style="max-width: 100%; max-height: 100%;"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">ğŸ® ê²Œì„ë³„ íŒë§¤ í˜„í™©</div>
                <div class="game-chart-container">
                    <canvas id="gameStatsChart" width="350" height="350"></canvas>
                </div>
            </div>

            <!-- ìµœê·¼ í™œë™ ì„¹ì…˜ -->
            <div class="recent-section">
                <div class="section-title">
                    <span>ğŸ•’ ìµœê·¼ í™œë™</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr; gap: 25px;">
                    <div>
                        <h4 style="color: #00ff88; margin-bottom: 15px;">ìµœê·¼ íŒë§¤ (íŒë§¤ì¼ ê¸°ì¤€ 5ê±´)</h4>
                        <div id="recentSales"></div>
                    </div>
                    
                    <div>
                        <h4 style="color: #00ff88; margin-bottom: 15px;">ìµœê·¼ íˆ¬ì (ì›”ë³„ ê¸°ì¤€ 5ê±´)</h4>
                        <div id="recentInvestments"></div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h4 style="color: #ff0099; margin-bottom: 15px;">ğŸ“‹ ì „ì²´ ìµœê·¼ í™œë™ (ë“±ë¡/ìˆ˜ì • ì‹œê°„ ê¸°ì¤€ 10ê±´)</h4>
                    <div id="recentActivities"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, orderBy, limit, where } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getUserGameFilter, shouldFilterByGame } from './common.js';
        
        // Firebase ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyBOikXWOMg3uj-f_kdnXh394sVDHMtboaE",
            authDomain: "game-inventory-system.firebaseapp.com",
            projectId: "game-inventory-system",
            storageBucket: "game-inventory-system.appspot.com",
            messagingSenderId: "930027493877",
            appId: "1:930027493877:web:87974d860dae032fbea8bc"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let salesChart, profitChart, gameChart;
        let currentUser = null;

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function isAnonymousUser() {
            return currentUser && currentUser.isAnonymous;
        }

        function showNotification(message, type = 'success') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // ì¸ì¦ ìƒíƒœ í™•ì¸
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userEmailElement = document.getElementById('userEmail');
                if (userEmailElement) {
                    if (user.isAnonymous) {
                        userEmailElement.innerHTML = 'ğŸ” ê²ŒìŠ¤íŠ¸ ì‚¬ìš©ì <small style="color: #999;">(ì½ê¸° ì „ìš©)</small>';
                    } else {
                        userEmailElement.textContent = user.email;
                    }
                }
                setTimeout(loadDashboardData, 500);
            } else {
                window.location.href = 'index.html';
            }
        });

        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        document.getElementById('logoutBtn').addEventListener('click', () => {
            const message = isAnonymousUser() ? 
                'ê²ŒìŠ¤íŠ¸ ì„¸ì…˜ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 
                'ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                
            if (confirm(message)) {
                signOut(auth).then(() => {
                    window.location.href = 'index.html';
                });
            }
        });

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
        window.refreshDashboard = refreshDashboard;
        window.loadDashboardData = loadDashboardData;

        // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
        async function loadDashboardData() {
            try {
                const userGameFilter = getUserGameFilter(auth.currentUser.email);
        
                // ëª¨ë“  ë°ì´í„° ë™ì‹œ ë¡œë“œ
                let salesQuery, inventoryQuery;
                
                if (userGameFilter) {
                    salesQuery = query(
                        collection(db, 'sales'),
                        where('gameName', '==', userGameFilter)
                    );
                    inventoryQuery = query(
                        collection(db, 'inventory'),
                        where('gameName', '==', userGameFilter)
                    );
                } else {
                    salesQuery = collection(db, 'sales');
                    inventoryQuery = collection(db, 'inventory');
                }
                
                const [salesData, investmentData, inventoryData] = await Promise.all([
                    getDocs(salesQuery),
                    getDocs(collection(db, 'investments')), // íˆ¬ìëŠ” ê²Œì„ë³„ í•„í„°ë§ ì•ˆí•¨
                    getDocs(inventoryQuery)
                ]);
                // íŒë§¤ ë°ì´í„° ì²˜ë¦¬
                const sales = [];
                let totalSales = 0;
                let totalReceived = 0;
                let totalTransactions = 0;

                salesData.forEach(doc => {
                    const data = doc.data();
                    sales.push(data);
                    totalSales += data.totalPrice || 0;
                    totalReceived += data.receivedAmount || 0;
                    totalTransactions++;
                });

                // íˆ¬ì ë°ì´í„° ì²˜ë¦¬
                const investments = [];
                let totalInvestment = 0;

                investmentData.forEach(doc => {
                    const data = doc.data();
                    investments.push(data);
                    totalInvestment += data.amount || 0;
                });

                // ì¬ê³  ë°ì´í„° ì²˜ë¦¬
                const inventory = [];
                let totalInventory = 0;
                inventoryData.forEach(doc => {
                    const data = doc.data();
                    inventory.push(data);
                    totalInventory += data.diamondCount || 0;
                });

                // ìˆœì´ìµ ê³„ì‚°
                const totalProfit = totalReceived - totalInvestment;

                // UI ì—…ë°ì´íŠ¸
                updateDashboardCards({
                    totalSales,
                    totalReceived,
                    totalInvestment,
                    totalProfit,
                    totalTransactions,
                    totalInventory
                });

                // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                updateCharts(sales, investments);

                // ìµœê·¼ í™œë™ ì—…ë°ì´íŠ¸ (ì¬ê³  ë°ì´í„°ë„ ì „ë‹¬)
                updateRecentActivities(sales, investments, inventory);

            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboardCards(data) {
            document.getElementById('totalSalesValue').textContent = data.totalSales.toLocaleString() + 'ì›';
            document.getElementById('totalReceivedValue').textContent = data.totalReceived.toLocaleString() + 'ì›';
            document.getElementById('totalInvestmentValue').textContent = data.totalInvestment.toLocaleString() + 'ì›';
            document.getElementById('totalProfitValue').textContent = data.totalProfit.toLocaleString() + 'ì›';
            document.getElementById('totalTransactionsValue').textContent = data.totalTransactions.toLocaleString() + 'ê±´';
            document.getElementById('totalInventoryValue').textContent = data.totalInventory.toLocaleString() + 'ê°œ';

            // ìˆœì´ìµì´ ìŒìˆ˜ë©´ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ
            const profitElement = document.getElementById('totalProfitValue');
            if (data.totalProfit < 0) {
                profitElement.style.color = '#ff3333';
                profitElement.style.textShadow = '0 0 15px rgba(255, 51, 51, 0.8)';
            }
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateCharts(salesData, investmentData) {
            // ì›”ë³„ ë°ì´í„° ì§‘ê³„
            const monthlyData = {};

            // íŒë§¤ ë°ì´í„° ì§‘ê³„
            salesData.forEach(item => {
                if (item.saleDate) {
                    const date = new Date(item.saleDate);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    // ì›” ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìƒì„±
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            sales: 0,
                            received: 0,
                            investment: 0,
                            transactions: 0
                        };
                    }
                    
                    monthlyData[monthKey].sales += item.totalPrice || 0;
                    monthlyData[monthKey].received += item.receivedAmount || 0;
                    monthlyData[monthKey].transactions++;
                }
            });

            // íˆ¬ì ë°ì´í„° ì§‘ê³„
            investmentData.forEach(item => {
                if (item.investmentDate) {  // item.month ëŒ€ì‹  item.investmentDate ì‚¬ìš©
                    const date = new Date(item.investmentDate);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    // ì›” ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìƒì„±
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            sales: 0,
                            received: 0,
                            investment: 0,
                            transactions: 0
                        };
                    }
                    
                    monthlyData[monthKey].investment += item.amount || 0;
                }
            });

            // ê²Œì„ë³„ ë°ì´í„° ì§‘ê³„
            const gameData = {};
            salesData.forEach(item => {
                const gameName = item.gameName || 'ê¸°íƒ€';
                if (!gameData[gameName]) {
                    gameData[gameName] = {
                        sales: 0,
                        transactions: 0
                    };
                }
                gameData[gameName].sales += item.totalPrice || 0;
                gameData[gameName].transactions++;
            });

            // ì°¨íŠ¸ ìƒì„± ì „ì— ì›”ë³„ ë°ì´í„°ë¥¼ ì •ë ¬ëœ ìˆœì„œë¡œ ì¬êµ¬ì„±
            const sortedMonthKeys = Object.keys(monthlyData).sort();
            const sortedMonthlyData = {};

            sortedMonthKeys.forEach(key => {
                sortedMonthlyData[key] = monthlyData[key];
            });

            // ì°¨íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸
            createMonthlySalesChart(sortedMonthlyData);
            createMonthlyProfitChart(sortedMonthlyData);
            createGameStatsChart(gameData);
        }

        // ì›”ë³„ íŒë§¤ ì°¨íŠ¸
        function createMonthlySalesChart(sortedMonthlyData) {
            const ctx = document.getElementById('monthlySalesChart').getContext('2d');
            
            if (salesChart) {
                salesChart.destroy();
            }

            const months = Object.keys(sortedMonthlyData).map(key => {
                const [year, month] = key.split('-');
                return `${month}ì›”`;
            });

            // ìˆ˜ì • (ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜)
            const salesValues = Object.values(sortedMonthlyData).map(data => Math.round(data.sales / 10000));
            const transactionCounts = Object.values(sortedMonthlyData).map(data => data.transactions);

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'íŒë§¤ê¸ˆì•¡',
                        data: salesValues,
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'ê±°ë˜ê±´ìˆ˜',
                        data: transactionCounts,
                        borderColor: '#ff0099',
                        backgroundColor: 'rgba(255, 0, 153, 0.1)',
                        borderWidth: 2,
                        type: 'bar',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#00ff88'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#00ccff' },
                            grid: { color: 'rgba(0, 255, 136, 0.1)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { 
                                color: '#00ff88',
                                callback: function(value) {
                                    return value.toLocaleString() + 'ë§Œì›';
                                }
                            },
                            grid: { color: 'rgba(0, 255, 136, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { 
                                color: '#ff0099',
                                callback: function(value) {
                                    return value + 'ê±´';
                                }
                            },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // ì›”ë³„ ìˆ˜ìµ ë¹„êµ ì°¨íŠ¸
        function createMonthlyProfitChart(sortedMonthlyData) {
            const ctx = document.getElementById('monthlyProfitChart').getContext('2d');
            
            if (profitChart) {
                profitChart.destroy();
            }

            const months = Object.keys(sortedMonthlyData).map(key => {
                const [year, month] = key.split('-');
                return `${month}ì›”`;
            });

            const receivedValues = Object.values(sortedMonthlyData).map(data => Math.round(data.received / 10000));
            const investmentValues = Object.values(sortedMonthlyData).map(data => Math.round(data.investment / 10000));

            profitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'ìˆ˜ë ¹ê¸ˆì•¡',
                        data: receivedValues,
                        backgroundColor: 'rgba(0, 255, 136, 0.7)',
                        borderColor: '#00ff88',
                        borderWidth: 2
                    }, {
                        label: 'íˆ¬ìê¸ˆì•¡',
                        data: investmentValues,
                        backgroundColor: 'rgba(255, 0, 153, 0.7)',
                        borderColor: '#ff0099',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#00ff88'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#00ccff' },
                            grid: { color: 'rgba(0, 255, 136, 0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: '#00ff88',
                                callback: function(value) {
                                    return value.toLocaleString() + 'ë§Œì›';
                                }
                            },
                            grid: { color: 'rgba(0, 255, 136, 0.1)' }
                        }
                    }
                }
            });
        }

        // ê²Œì„ë³„ í†µê³„ ì°¨íŠ¸
        function createGameStatsChart(gameData) {
            const ctx = document.getElementById('gameStatsChart').getContext('2d');
            
            if (gameChart) {
                gameChart.destroy();
            }

            const gameNames = Object.keys(gameData);
            const gameSales = Object.values(gameData).map(data => data.sales);
            const totalSales = gameSales.reduce((sum, value) => sum + value, 0);

            // í¼ì„¼í‹°ì§€ ê³„ì‚°
            const gameLabelsWithPercentage = gameNames.map((name, index) => {
                const percentage = totalSales > 0 ? Math.round((gameSales[index] / totalSales) * 100) : 0;
                return `${name} (${percentage}%)`;
            });

            // ëœë¤ ìƒ‰ìƒ ìƒì„±
            const colors = gameNames.map(() => {
                const hue = Math.random() * 360;
                return `hsl(${hue}, 70%, 60%)`;
            });

            gameChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: gameLabelsWithPercentage,
                    datasets: [{
                        data: gameSales,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('60%', '80%')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#00ff88',
                                padding: 15,
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    return `${label}: ${value.toLocaleString()}ì›`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ìµœê·¼ í™œë™ ì—…ë°ì´íŠ¸ (updatedAt ìš°ì„  ì²˜ë¦¬)
        async function updateRecentActivities(salesData, investmentData, inventoryData) {
            // ìµœê·¼ íŒë§¤ 5ê±´ (íŒë§¤ì¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬)
            const recentSales = salesData
                .filter(item => item.saleDate) // íŒë§¤ì¼ì´ ìˆëŠ” ê²ƒë§Œ
                .sort((a, b) => {
                    const dateA = new Date(a.saleDate);
                    const dateB = new Date(b.saleDate);
                    return dateB - dateA; // ìµœì‹  íŒë§¤ì¼ ìˆœ
                })
                .slice(0, 5);

            const recentSalesHtml = recentSales.map(item => {
                const createdDate = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt || 0);
                const formattedDate = createdDate.toLocaleDateString('ko-KR', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="recent-item">
                        <div class="recent-item-header">
                            <span class="recent-item-title">${item.gameName} - ${item.serverName}</span>
                            <span class="recent-item-amount">${item.totalPrice?.toLocaleString() || 0}ì›</span>
                        </div>
                        <div class="recent-item-date">ğŸ“… ${item.saleDate} | â° ${formattedDate}</div>
                    </div>
                `;
            }).join('');

            // ìµœê·¼ íˆ¬ì 5ê±´ (ì›”ë³„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬)
            const recentInvestments = investmentData
                .sort((a, b) => {
                    // íˆ¬ìì¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ìµœì‹  ìˆœ)
                    if (a.investmentDate !== b.investmentDate) {
                        return (b.investmentDate || '').localeCompare(a.investmentDate || '');
                    }
                    // ê°™ì€ ë‚ ì´ë©´ ë“±ë¡ì¼ ê¸°ì¤€
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateB - dateA;
                })
                .slice(0, 5);

            const recentInvestmentsHtml = recentInvestments.map(item => {
                const createdDate = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt || 0);
                const formattedDate = createdDate.toLocaleDateString('ko-KR', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // investmentDateë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚ ì§œ í‘œì‹œ
                const investmentDateText = item.investmentDate ? 
                    new Date(item.investmentDate).toLocaleDateString('ko-KR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'ë‚ ì§œ ë¯¸ìƒ';
                
                return `
                    <div class="recent-item">
                        <div class="recent-item-header">
                            <span class="recent-item-title">${item.type || 'íˆ¬ì'}</span>
                            <span class="recent-item-amount">${item.amount?.toLocaleString() || 0}ì›</span>
                        </div>
                        <div class="recent-item-date">ğŸ“… ${investmentDateText} | ğŸ“ ${item.memo || ''} | â° ${formattedDate}</div>
                    </div>
                `;
            }).join('');

            // ì „ì²´ ìµœê·¼ í™œë™ 10ê±´ (íŒë§¤, íˆ¬ì, ì¬ê³  ëª¨ë“  ë°ì´í„° í¬í•¨, ìµœì‹  ì‹œê°„ ê¸°ì¤€)
            const allActivities = [];
            
            // íŒë§¤ ë°ì´í„° ì¶”ê°€
            salesData.forEach(item => {
                const createdDate = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt || 0);
                allActivities.push({
                    type: 'sale',
                    title: `ğŸ›’ ${item.gameName} - ${item.serverName}`,
                    amount: item.totalPrice || 0,
                    detail: `íŒë§¤ì¼: ${item.saleDate || 'ë¯¸ìƒ'} | ë‹¤ì´ì•„: ${(item.diamondCount || 0).toLocaleString()}ê°œ`,
                    createdAt: createdDate,
                    isUpdated: false
                });
            });
            
            // íˆ¬ì ë°ì´í„° ì¶”ê°€
            investmentData.forEach(item => {
                const createdDate = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt || 0);
                const investmentDateText = item.investmentDate ? 
                    new Date(item.investmentDate).toLocaleDateString('ko-KR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'ë‚ ì§œ ë¯¸ìƒ';
                
                allActivities.push({
                    type: 'investment',
                    title: `ğŸ’° ${item.type || 'íˆ¬ì'}`,
                    amount: item.amount || 0,
                    detail: `${investmentDateText} | ${item.memo || 'ë©”ëª¨ ì—†ìŒ'}`,
                    createdAt: createdDate,
                    isUpdated: false
                });
            });

            // ì¬ê³  ë°ì´í„° ì¶”ê°€ (updatedAt ìš°ì„ , ì—†ìœ¼ë©´ createdAt ì‚¬ìš©)
            inventoryData.forEach(item => {
                // updatedAtê³¼ createdAt ë¹„êµí•˜ì—¬ ì‹¤ì œ ìˆ˜ì • ì—¬ë¶€ íŒë‹¨
                let activityDate;
                let isUpdated = false;
                
                const createdDate = item.createdAt?.toDate ? item.createdAt.toDate() : new Date(item.createdAt || 0);
                const updatedDate = item.updatedAt?.toDate ? item.updatedAt.toDate() : null;
                
                if (updatedDate && updatedDate > createdDate) {
                    // updatedAtì´ createdAtë³´ë‹¤ ë‚˜ì¤‘ì´ë©´ ì‹¤ì œ ìˆ˜ì •ëœ ê²ƒ
                    activityDate = updatedDate;
                    isUpdated = true;
                } else {
                    // updatedAtì´ ì—†ê±°ë‚˜ createdAtê³¼ ê°™ìœ¼ë©´ ìµœì´ˆ ìƒì„±
                    activityDate = createdDate;
                    isUpdated = false;
                }
                
                allActivities.push({
                    type: 'inventory',
                    title: `ğŸ“¦ ${item.gameName} - ${item.serverName}`,
                    amount: item.diamondCount || 0,
                    detail: `${item.computerName} | ${item.accountName}`,
                    createdAt: activityDate,
                    isUpdated: isUpdated
                });
            });
            
            // ìµœì‹  ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ê³  10ê±´ë§Œ
            const recentActivitiesSorted = allActivities
                .sort((a, b) => b.createdAt - a.createdAt)
                .slice(0, 10);
            
            const recentActivitiesHtml = recentActivitiesSorted.map(item => {
                const formattedDate = item.createdAt.toLocaleDateString('ko-KR', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let amountColor, amountSign, amountText;
                
                if (item.type === 'sale') {
                    amountColor = '#00ff88';
                    amountSign = '+';
                    amountText = `${item.amount.toLocaleString()}ì›`;
                } else if (item.type === 'investment') {
                    amountColor = '#ff0099';
                    amountSign = '-';
                    amountText = `${item.amount.toLocaleString()}ì›`;
                } else { // inventory
                    amountColor = '#00ccff';
                    amountSign = '';
                    amountText = `${item.amount.toLocaleString()}ê°œ`;
                }
                
                // ì—…ë°ì´íŠ¸ëœ í•­ëª©ì— í‘œì‹œ ì¶”ê°€
                const updatedIndicator = item.isUpdated ? '<span class="updated-indicator">ìˆ˜ì •ë¨</span>' : '';
                
                return `
                    <div class="recent-item">
                        <div class="recent-item-header">
                            <span class="recent-item-title">${item.title}${updatedIndicator}</span>
                            <span class="recent-item-amount" style="color: ${amountColor};">${amountSign}${amountText}</span>
                        </div>
                        <div class="recent-item-date">${item.detail} | â° ${formattedDate}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('recentSales').innerHTML = recentSalesHtml || '<div style="color: #666; text-align: center; padding: 20px;">íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            document.getElementById('recentInvestments').innerHTML = recentInvestmentsHtml || '<div style="color: #666; text-align: center; padding: 20px;">íˆ¬ì ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            document.getElementById('recentActivities').innerHTML = recentActivitiesHtml || '<div style="color: #666; text-align: center; padding: 20px;">í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        // ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
        function refreshDashboard() {
            showNotification('ëŒ€ì‹œë³´ë“œë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” ì¤‘...', 'info');
            
            // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
            const valueElements = ['totalSalesValue', 'totalReceivedValue', 'totalInvestmentValue', 'totalProfitValue', 'totalTransactionsValue', 'totalInventoryValue'];
            valueElements.forEach(id => {
                document.getElementById(id).innerHTML = '<span class="loading-spinner"></span>';
            });

            loadDashboardData().then(() => {
                showNotification('ëŒ€ì‹œë³´ë“œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            });
        }
    </script>
</body>
</html>